<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ PRO v2 ‚Äî Azza Fencing</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Load Cyrillic font asynchronously
        let cyrillicFontLoaded = false;
        let cyrillicFontData = null;
        
        async function loadCyrillicFont() {
            try {
                // Try loading Roboto from Google Fonts CDN
                const response = await fetch('https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Me5Q.ttf');
                if (!response.ok) throw new Error('Font load failed');
                const buffer = await response.arrayBuffer();
                cyrillicFontData = arrayBufferToBase64(buffer);
                cyrillicFontLoaded = true;
                console.log('Cyrillic font loaded successfully');
            } catch (e) {
                console.log('Font loading failed, PDF will use transliteration:', e.message);
            }
        }
        
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        // Start loading font on page load
        loadCyrillicFont();
    </script>
    
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-panel: rgba(255, 255, 255, 0.05);
            --text-primary: #eee;
            --text-secondary: #aaa;
            --text-muted: #666;
            --accent: #00d9ff;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --success: #00c853;
            --warning: #ffa502;
            --danger: #ff4757;
            --border: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #e8ecef;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #1a1a2e;
            --text-secondary: #555;
            --text-muted: #888;
            --accent: #0066cc;
            --accent-glow: rgba(0, 102, 204, 0.2);
            --border: rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        body.fullscreen { padding: 10px; }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .header h1 {
            margin: 0;
            color: var(--accent);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .model-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .session-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .session-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 13px;
        }
        
        /* Panels */
        .panel {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .panel-title {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0;
        }
        
        .panel-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .tab:hover { background: var(--bg-panel); }
        .tab.active { background: var(--accent); color: #000; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Grid layout */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        
        /* Form elements */
        .field { margin-bottom: 12px; }
        .field label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px; }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }
        
        [data-theme="light"] select,
        [data-theme="light"] input[type="text"],
        [data-theme="light"] input[type="number"] {
            background: rgba(255, 255, 255, 0.8);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        
        .scan-input {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #00a8cc 100%); color: #000; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px var(--accent-glow); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #00a844 100%); color: #fff; }
        .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #e67e00 100%); color: #000; }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: #fff; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-ghost:hover { background: var(--bg-panel); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        
        /* Stream mode indicator */
        .stream-mode-active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }
        
        .stream-badge {
            background: #ff6b6b;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        
        /* Color tags */
        .color-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        
        .color-tag {
            background: rgba(102, 126, 234, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-tag .remove { cursor: pointer; opacity: 0.6; font-size: 14px; }
        .color-tag .remove:hover { opacity: 1; }
        .add-inline { display: flex; gap: 8px; }
        .add-inline input { width: 150px; }
        
        /* Stats cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 16px; }
        
        .stat-card {
            background: var(--bg-panel);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .stat-value { font-size: 24px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Progress */
        .progress-container { margin-bottom: 16px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .progress-bar { height: 12px; background: var(--bg-panel); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.5s ease; border-radius: 6px; }
        
        /* Boxes */
        .boxes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        
        .box-card {
            background: var(--bg-panel);
            border-radius: 12px;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .box-card.active { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .box-card.full { border-color: var(--success); }
        
        .box-header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .box-name { font-weight: 600; font-size: 14px; }
        .box-count { font-size: 12px; color: var(--text-secondary); }
        .box-count.full { color: var(--success); font-weight: 600; }
        
        .box-body { padding: 12px 16px; }
        
        .box-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .box-progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }
        
        .box-progress-fill.full { background: var(--success); }
        
        .box-contents {
            font-size: 11px;
            color: var(--text-secondary);
            max-height: 60px;
            overflow-y: auto;
        }
        
        .box-actions { display: flex; gap: 6px; margin-top: 10px; }
        
        /* Data table */
        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { padding-left: 36px; }
        .search-box::before { content: "üîç"; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 14px; }
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-group select { width: auto; min-width: 100px; }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        table.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        
        .data-table th {
            background: rgba(0, 217, 255, 0.1);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        
        .data-table th:hover { background: rgba(0, 217, 255, 0.2); }
        .data-table th .sort-icon { margin-left: 4px; opacity: 0.5; }
        .data-table th.sorted .sort-icon { opacity: 1; }
        .data-table td { padding: 10px; border-top: 1px solid var(--border); vertical-align: middle; }
        .data-table tr:hover { background: rgba(255, 255, 255, 0.03); }
        .data-table tr.selected { background: rgba(0, 217, 255, 0.1); }
        
        .code-cell { font-family: 'Courier New', monospace; font-size: 10px; word-break: break-all; max-width: 200px; }
        .gtin-cell { font-family: 'Courier New', monospace; font-weight: 600; color: #ffd700; }
        .row-num { color: var(--text-muted); }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .status-unknown { background: var(--text-muted); color: #fff; }
        .status-checking { background: var(--warning); color: #000; }
        .status-valid { background: var(--success); color: #fff; }
        .status-invalid { background: var(--danger); color: #fff; }
        
        .checkbox-cell { width: 30px; text-align: center; }
        .checkbox-cell input { width: 16px; height: 16px; cursor: pointer; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        
        /* Matrix */
        .matrix-container { overflow-x: auto; }
        .matrix { border-collapse: collapse; font-size: 12px; width: 100%; }
        .matrix th, .matrix td { padding: 8px 12px; text-align: center; border: 1px solid var(--border); min-width: 50px; }
        .matrix th { background: rgba(0, 217, 255, 0.1); color: var(--accent); font-weight: 600; }
        .matrix td { background: var(--bg-panel); }
        .matrix td.has-items { background: rgba(0, 200, 83, 0.2); color: var(--success); font-weight: 600; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 14px 20px;
            border-radius: 12px;
            color: #fff;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
            font-size: 13px;
        }
        
        /* Work Mode Buttons */
        .work-mode-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--bg-panel);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .work-mode-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .work-mode-btn.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--accent) 0%, #00a8cc 100%);
            color: #000;
        }
        
        .work-mode-btn.active[data-mode="receiving"] {
            background: linear-gradient(135deg, #00c853 0%, #00a844 100%);
            border-color: #00c853;
        }
        
        .work-mode-btn.active[data-mode="inventory"] {
            background: linear-gradient(135deg, #ffa502 0%, #e67e00 100%);
            border-color: #ffa502;
        }
        
        .work-mode-btn.active[data-mode="shipping"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        
        .work-mode-btn .mode-icon {
            font-size: 16px;
        }
        
        @media (max-width: 600px) {
            .work-mode-btn .mode-label {
                display: none;
            }
            .work-mode-btn {
                padding: 8px 12px;
            }
        }
        
        /* Reconciliation status */
        .rec-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .rec-status.done {
            background: rgba(0, 200, 83, 0.2);
            color: var(--success);
        }
        
        .rec-status.partial {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
        }
        
        .rec-status.missing {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
        }
        
        .rec-status.extra {
            background: rgba(255, 165, 2, 0.2);
            color: var(--warning);
        }
        
        .rec-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #00a844 100%);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 100;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
        }
        
        .rec-indicator.active {
            display: flex;
        }
        
        .toast-success { background: linear-gradient(135deg, var(--success) 0%, #00a844 100%); }
        .toast-error { background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); }
        .toast-warning { background: linear-gradient(135deg, var(--warning) 0%, #e67e00 100%); color: #000; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title { font-size: 18px; font-weight: 600; color: var(--accent); }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        
        /* Label preview */
        .label-preview {
            background: #fff;
            color: #000;
            padding: 20px;
            border-radius: 8px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
        }
        
        .label-preview h3 { margin: 0 0 10px 0; font-size: 18px; }
        .label-preview .label-info { font-size: 12px; margin: 4px 0; }
        .label-preview .label-contents { font-size: 10px; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; }
        
        /* Hotkeys */
        .hotkeys { display: flex; gap: 16px; flex-wrap: wrap; font-size: 11px; color: var(--text-muted); margin-bottom: 16px; }
        .hotkey { display: flex; align-items: center; gap: 6px; }
        .hotkey kbd { background: var(--bg-panel); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); font-family: monospace; }
        
        /* API Status indicator */
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .api-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .api-dot.connected { background: var(--success); }
        .api-dot.error { background: var(--danger); }
        
        /* Print styles */
        @media print {
            body { background: #fff !important; color: #000 !important; padding: 10px; }
            .panel { background: #fff !important; border: 1px solid #ddd !important; break-inside: avoid; }
            .header-controls, .tabs, .table-controls, .btn, .panel-actions, .hotkeys { display: none !important; }
            .tab-content { display: block !important; }
            .data-table th { background: #f0f0f0 !important; color: #000 !important; }
            .toast, .modal-overlay { display: none !important; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .header-controls { justify-content: center; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .table-controls { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group select { flex: 1; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <!-- Reconciliation indicator -->
        <div class="rec-indicator" id="recIndicator">
            üìã –°–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞: <span id="recIndicatorText">0/0</span>
        </div>
        
        <!-- Header -->
        <div class="header">
            <h1>üì¶ –°–∫–∞–Ω–µ—Ä –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ PRO v2</h1>
            <div class="header-controls">
                <span class="model-badge">Azza Fencing</span>
                <span class="model-badge" id="workModeBadge" style="background: linear-gradient(135deg, #00c853 0%, #00a844 100%);">üì• –ü—Ä–∏—ë–º–∫–∞</span>
                
                <div class="api-status" id="apiStatus">
                    <span class="api-dot"></span>
                    <span>API: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                </div>
                
                <div class="session-selector">
                    <select id="sessionSelect" onchange="switchSession()"></select>
                    <button class="btn btn-ghost btn-sm" onclick="showNewSessionModal()">+ –ü–∞—Ä—Ç–∏—è</button>
                </div>
                
                <button class="btn btn-icon btn-ghost" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
                <button class="btn btn-icon btn-ghost" onclick="toggleFullscreen()" title="–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω">‚õ∂</button>
                <button class="btn btn-icon btn-ghost" onclick="toggleSound()" id="soundBtn" title="–ó–≤—É–∫">üîä</button>
                <button class="btn btn-icon btn-ghost" onclick="toggleVoice()" id="voiceBtn" title="–ì–æ–ª–æ—Å">üó£Ô∏è</button>
            </div>
        </div>
        
        <!-- Hotkeys hint -->
        <div class="hotkeys">
            <div class="hotkey"><kbd>1-9</kbd> –†–∞–∑–º–µ—Ä 36-44</div>
            <div class="hotkey"><kbd>0</kbd> –†–∞–∑–º–µ—Ä 45</div>
            <div class="hotkey"><kbd>S</kbd> –ü–æ—Ç–æ–∫. —Ä–µ–∂–∏–º</div>
            <div class="hotkey"><kbd>Ctrl+E</kbd> –≠–∫—Å–ø–æ—Ä—Ç</div>
            <div class="hotkey"><kbd>Del</kbd> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</div>
            <div class="hotkey"><kbd>–ü—Ä–æ–±–µ–ª</kbd> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ú–æ–π–°–∫–ª–∞–¥)</div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scan')">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="tab" onclick="switchTab('reconciliation')">üìã –°–≤–µ—Ä–∫–∞</button>
            <button class="tab" onclick="switchTab('moysklad')">üöÄ –ú–æ–π–°–∫–ª–∞–¥</button>
            <button class="tab" onclick="switchTab('catalog')">üìö –ö–∞—Ç–∞–ª–æ–≥ GTIN</button>
            <button class="tab" onclick="switchTab('boxes')">üì¶ –ö–æ—Ä–æ–±–∫–∏</button>
            <button class="tab" onclick="switchTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="tab" onclick="switchTab('history')">üóëÔ∏è –£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
        </div>
        
        <!-- Scan Tab -->
        <div class="tab-content active" id="tab-scan">
            <!-- Work Mode Selector -->
            <div class="panel" style="padding: 12px 20px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">–†–µ–∂–∏–º:</span>
                        <div class="work-mode-tabs" style="display: flex; gap: 4px;">
                            <button class="work-mode-btn active" data-mode="receiving" onclick="setWorkMode('receiving')">
                                <span class="mode-icon">üì•</span>
                                <span class="mode-label">–ü—Ä–∏—ë–º–∫–∞</span>
                            </button>
                            <button class="work-mode-btn" data-mode="inventory" onclick="setWorkMode('inventory')">
                                <span class="mode-icon">üìã</span>
                                <span class="mode-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</span>
                            </button>
                            <button class="work-mode-btn" data-mode="shipping" onclick="setWorkMode('shipping')">
                                <span class="mode-icon">üì§</span>
                                <span class="mode-label">–û—Ç–ø—Ä–∞–≤–∫–∞</span>
                            </button>
                        </div>
                    </div>
                    <div id="workModeInfo" style="font-size: 12px; color: var(--text-secondary);">
                        –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                    </div>
                </div>
            </div>
            
            <!-- Auto mode banner -->
            <div class="panel" id="autoModePanel" style="border-color: var(--success); background: rgba(0, 200, 83, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <span style="font-size: 18px;">üöÄ</span>
                        <strong style="color: var(--success);">–ê–í–¢–û–†–ï–ñ–ò–ú</strong>
                        <span style="color: var(--text-secondary); font-size: 13px; margin-left: 8px;">
                            –¶–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ GTIN
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; color: var(--text-muted);">
                            –í –∫–∞—Ç–∞–ª–æ–≥–µ: <strong id="catalogCount">0</strong> GTIN
                        </span>
                        <button class="btn btn-ghost btn-sm" onclick="switchTab('catalog')">üìö –ö–∞—Ç–∞–ª–æ–≥</button>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="autoModeToggle" checked onchange="toggleAutoMode()">
                            <span style="font-size: 12px;">–í–∫–ª</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Stream mode panel -->
            <div class="panel" id="streamModePanel" style="display: none; border-color: #ff6b6b;">
                <div class="panel-header">
                    <h3 class="panel-title" style="color: #ff6b6b;">üî• –ü–û–¢–û–ö–û–í–´–ô –†–ï–ñ–ò–ú –ê–ö–¢–ò–í–ï–ù</h3>
                    <button class="btn btn-danger btn-sm" onclick="toggleStreamMode()">‚úï –í—ã–∫–ª—é—á–∏—Ç—å</button>
                </div>
                <p style="font-size: 13px; margin: 0;">
                    –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ–¥—ã –ø–æ–¥—Ä—è–¥. –¶–≤–µ—Ç: <strong id="streamColor">-</strong>, 
                    –†–∞–∑–º–µ—Ä: <strong id="streamSize">-</strong>, 
                    –ö–æ—Ä–æ–±–∫–∞: <strong id="streamBox">-</strong>
                </p>
            </div>
            
            <!-- Scanning panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <div class="panel-actions">
                        <button class="btn btn-warning btn-sm" id="streamModeBtn" onclick="toggleStreamMode()">
                            üî• –ü–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showCameraModal()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                    </div>
                </div>
                
                <div class="grid-4">
                    <div class="field" id="colorField">
                        <label>–¶–≤–µ—Ç <span class="auto-hint" style="color: var(--success); font-size: 10px;">(–∞–≤—Ç–æ)</span></label>
                        <select id="colorSelect">
                            <option value="">‚Äî –ê–≤—Ç–æ ‚Äî</option>
                        </select>
                    </div>
                    <div class="field" id="sizeField">
                        <label>–†–∞–∑–º–µ—Ä <span class="auto-hint" style="color: var(--success); font-size: 10px;">(–∞–≤—Ç–æ)</span></label>
                        <select id="sizeSelect">
                            <option value="">‚Äî –ê–≤—Ç–æ ‚Äî</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>–ö–æ—Ä–æ–±–∫–∞</label>
                        <select id="boxSelect">
                            <option value="">‚Äî –ë–µ–∑ –∫–æ—Ä–æ–±–∫–∏ ‚Äî</option>
                        </select>
                    </div>
                    <div class="field" style="grid-column: span 1;">
                        <label>–ö–æ–¥ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</label>
                        <div style="display: flex; gap: 8px;">
                            <div id="scanDisplay" style="
                                flex: 1;
                                background: rgba(0, 0, 0, 0.3);
                                border: 2px solid var(--border);
                                border-radius: 10px;
                                padding: 12px 16px;
                                min-height: 24px;
                                font-family: monospace;
                                font-size: 13px;
                                color: var(--accent);
                                cursor: default;
                                transition: all 0.2s;
                            ">
                                ‚è≥ –ù–∞–≤–µ–¥–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä...
                            </div>
                            <button class="btn btn-ghost" onclick="pasteFromClipboard()" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ (Ctrl+V)">üìã</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress -->
            <div class="panel" id="progressPanel" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                        <span id="progressText">0 / 0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid"></div>
            
            <!-- Table -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üìã –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h3>
                    <div class="panel-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="selectedCount">0</span>)
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="checkSelectedStatus()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                        <button class="btn btn-success btn-sm" onclick="exportXLSX()">üìä Excel</button>
                        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üìÑ CSV</button>
                        <button class="btn btn-primary btn-sm" onclick="generateModeReport()">üìã –û—Ç—á—ë—Ç</button>
                    </div>
                </div>
                
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable()">
                    </div>
                    <div class="filter-group">
                        <select id="filterColor" onchange="filterTable()">
                            <option value="">–í—Å–µ —Ü–≤–µ—Ç–∞</option>
                        </select>
                        <select id="filterSize" onchange="filterTable()">
                            <option value="">–í—Å–µ —Ä–∞–∑–º–µ—Ä—ã</option>
                        </select>
                        <select id="filterBox" onchange="filterTable()">
                            <option value="">–í—Å–µ –∫–æ—Ä–æ–±–∫–∏</option>
                        </select>
                        <button class="btn btn-ghost btn-sm" onclick="clearFilters()">‚úï</button>
                    </div>
                    <label style="font-size: 12px; display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                    </label>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"></th>
                                <th onclick="sortTable('index')">‚Ññ</th>
                                <th onclick="sortTable('color')">–¶–≤–µ—Ç</th>
                                <th onclick="sortTable('size')">–†–∞–∑–º–µ—Ä</th>
                                <th onclick="sortTable('box')">–ö–æ—Ä–æ–±–∫–∞</th>
                                <th onclick="sortTable('gtin')">GTIN</th>
                                <th>–û–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫–æ–¥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                    <div class="empty-state" id="emptyState">
                        <p>üì¶ –ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reconciliation Tab -->
        <div class="tab-content" id="tab-reconciliation">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üìã –°–≤–µ—Ä–∫–∞ —Å –Ω–∞–∫–ª–∞–¥–Ω–æ–π</h3>
                    <div class="panel-actions">
                        <button class="btn btn-ghost btn-sm" onclick="clearReconciliation()" id="clearRecBtn" style="display:none;">‚úï –û—á–∏—Å—Ç–∏—Ç—å —Å–≤–µ—Ä–∫—É</button>
                    </div>
                </div>
                
                <!-- No reconciliation loaded -->
                <div id="recEmpty">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--text-primary);">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞–∫–ª–∞–¥–Ω—É—é</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Excel –∏–ª–∏ CSV —Ñ–∞–π–ª –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</p>
                        <input type="file" id="recFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleReconciliationFile(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('recFileInput').click()">
                            üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                    </div>
                </div>
                
                <!-- Column mapping -->
                <div id="recMapping" style="display: none;">
                    <div style="background: rgba(0, 217, 255, 0.1); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600;">üìä –£–∫–∞–∂–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤:</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">
                            –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–æ–π —Å—Ç–æ–ª–±–µ—Ü —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        </p>
                    </div>
                    
                    <div style="overflow-x: auto; margin-bottom: 16px;">
                        <table class="data-table" id="recPreviewTable">
                            <thead id="recPreviewHead"></thead>
                            <tbody id="recPreviewBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="grid-4" style="margin-bottom: 16px;" id="recMappingSelects"></div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="applyReconciliationMapping()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-ghost" onclick="cancelReconciliationMapping()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
                
                <!-- Active reconciliation -->
                <div id="recActive" style="display: none;">
                    <!-- Summary bar -->
                    <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">–ù–ê–ö–õ–ê–î–ù–ê–Ø</div>
                                <div style="font-size: 16px; font-weight: 600;" id="recFileName">‚Äî</div>
                            </div>
                            <div class="stats-grid" style="display: flex; gap: 16px; margin: 0;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-muted);" id="recExpected">0</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">–û–∂–∏–¥–∞–µ—Ç—Å—è</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="recReceived">0</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">–ü—Ä–∏–Ω—è—Ç–æ</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="recMissing">0</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="recExtra">0</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">–õ–∏—à–Ω–∏–µ</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress bar -->
                        <div style="margin-top: 16px;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–≤–µ—Ä–∫–∏</span>
                                <span id="recProgressText">0%</span>
                            </div>
                            <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div id="recProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--success), #00a844); width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items list -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–¶–≤–µ—Ç</th>
                                    <th>–†–∞–∑–º–µ—Ä</th>
                                    <th>–û–∂–∏–¥–∞–µ—Ç—Å—è</th>
                                    <th>–ü—Ä–∏–Ω—è—Ç–æ</th>
                                    <th>–†–∞–∑–Ω–∏—Ü–∞</th>
                                </tr>
                            </thead>
                            <tbody id="recItemsBody"></tbody>
                        </table>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="switchTab('scan')">üì± –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é</button>
                        <button class="btn btn-success" onclick="generateReconciliationReport()">üìÑ –û—Ç—á—ë—Ç –æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö</button>
                        <button class="btn btn-ghost" onclick="document.getElementById('recFileInput').click()">üìÇ –î—Ä—É–≥–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MoySklad Tab -->
        <div class="tab-content" id="tab-moysklad">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üöÄ –ü–µ—Ä–µ–Ω–æ—Å –≤ –ú–æ–π–°–∫–ª–∞–¥</h3>
                    <div class="panel-actions">
                        <button class="btn btn-ghost btn-sm" onclick="resetMoySkladProgress()">üîÑ –°–Ω–∞—á–∞–ª–∞</button>
                    </div>
                </div>
                
                <div id="moyskladEmpty" class="empty-state">
                    <p>üì¶ –ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>
                    <p style="font-size: 12px;">–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"</p>
                </div>
                
                <div id="moyskladContent" style="display: none;">
                    <!-- Nomenclature selector -->
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                            –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞:
                        </label>
                        <div id="nomenclatureList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    
                    <!-- Conveyor -->
                    <div id="conveyorContainer" style="
                        background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
                        border: 2px solid var(--accent);
                        border-radius: 20px;
                        padding: 40px 30px;
                        text-align: center;
                        margin-bottom: 20px;
                    ">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                            <span id="conveyorNomenclature">‚Äî</span>
                        </div>
                        <div style="font-size: 16px; color: var(--accent); margin-bottom: 20px;">
                            –ö–æ–¥ <span id="conveyorCurrentNum">0</span> –∏–∑ <span id="conveyorTotalNum">0</span>
                        </div>
                        
                        <div id="conveyorCode" style="
                            background: rgba(0, 0, 0, 0.3);
                            border-radius: 12px;
                            padding: 24px 20px;
                            font-family: 'Courier New', monospace;
                            font-size: 14px;
                            word-break: break-all;
                            color: #ffd700;
                            margin-bottom: 24px;
                            min-height: 60px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            user-select: all;
                            cursor: text;
                        ">
                            ‚Äî
                        </div>
                        
                        <button id="conveyorButton" class="btn btn-primary" onclick="copyAndNext()" style="
                            font-size: 18px;
                            padding: 16px 48px;
                            border-radius: 12px;
                        ">
                            üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ò –î–ê–õ–¨–®–ï
                        </button>
                        
                        <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                            –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ <kbd style="background: var(--bg-panel); padding: 2px 8px; border-radius: 4px;">–ü—Ä–æ–±–µ–ª</kbd>
                        </div>
                        
                        <!-- Progress dots -->
                        <div id="conveyorProgress" style="
                            display: flex;
                            justify-content: center;
                            gap: 6px;
                            margin-top: 24px;
                            flex-wrap: wrap;
                            max-width: 400px;
                            margin-left: auto;
                            margin-right: auto;
                        "></div>
                    </div>
                    
                    <!-- Completed message -->
                    <div id="conveyorComplete" style="
                        display: none;
                        background: linear-gradient(135deg, rgba(0, 200, 83, 0.2) 0%, rgba(0, 168, 68, 0.2) 100%);
                        border: 2px solid var(--success);
                        border-radius: 20px;
                        padding: 40px;
                        text-align: center;
                    ">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <div style="font-size: 20px; font-weight: 600; color: var(--success); margin-bottom: 8px;">
                            –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞!
                        </div>
                        <div id="completedNomenclature" style="color: var(--text-secondary); margin-bottom: 20px;">
                            ‚Äî
                        </div>
                        <button class="btn btn-primary" onclick="nextNomenclature()">
                            –°–ª–µ–¥—É—é—â–∞—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ ‚Üí
                        </button>
                    </div>
                    
                    <!-- All done message -->
                    <div id="conveyorAllDone" style="
                        display: none;
                        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
                        border: 2px solid #667eea;
                        border-radius: 20px;
                        padding: 40px;
                        text-align: center;
                    ">
                        <div style="font-size: 48px; margin-bottom: 16px;">üéâ</div>
                        <div style="font-size: 20px; font-weight: 600; color: #667eea; margin-bottom: 8px;">
                            –í—Å–µ –∫–æ–¥—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!
                        </div>
                        <div style="color: var(--text-secondary); margin-bottom: 20px;">
                            –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <strong id="allDoneCount">0</strong> –∫–æ–¥–æ–≤
                        </div>
                        <button class="btn btn-ghost" onclick="resetMoySkladProgress()">
                            üîÑ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞
                        </button>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 20px;">
                        <div class="stat-card" style="flex: 1; min-width: 120px;">
                            <div class="stat-value" id="msTotal">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –∫–æ–¥–æ–≤</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 120px;">
                            <div class="stat-value" id="msCopied">0</div>
                            <div class="stat-label">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 120px;">
                            <div class="stat-value" id="msRemaining">0</div>
                            <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Catalog Tab -->
        <div class="tab-content" id="tab-catalog">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üìö –ö–∞—Ç–∞–ª–æ–≥ GTIN ‚Äî –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞</h3>
                    <div class="panel-actions">
                        <button class="btn btn-primary btn-sm" onclick="showAddGtinModal()">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
                        <button class="btn btn-ghost btn-sm" onclick="exportCatalog()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importCatalog').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
                        <input type="file" id="importCatalog" accept=".json,.csv" style="display:none;" onchange="importCatalog(event)">
                    </div>
                </div>
                
                <div style="background: rgba(0, 217, 255, 0.1); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                    <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></p>
                    <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary);">
                        <li>–ü—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ <strong>–Ω–æ–≤–æ–≥–æ GTIN</strong> ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Ü–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞</li>
                        <li>–°–∏—Å—Ç–µ–º–∞ <strong>–∑–∞–ø–æ–º–Ω–∏—Ç</strong> —ç—Ç—É –∫–æ–º–±–∏–Ω–∞—Ü–∏—é</li>
                        <li>–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç—Ç–æ–≥–æ GTIN ‚Äî —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è <strong>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</strong></li>
                    </ol>
                </div>
                
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="catalogSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ GTIN, —Ü–≤–µ—Ç—É..." oninput="renderCatalog()">
                    </div>
                    <span style="font-size: 13px; color: var(--text-muted);">
                        –í—Å–µ–≥–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: <strong id="catalogTotalCount">0</strong> –ø–æ–∑–∏—Ü–∏–π
                    </span>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>GTIN</th>
                                <th>–¶–≤–µ—Ç</th>
                                <th>–†–∞–∑–º–µ—Ä</th>
                                <th>–ú–æ–¥–µ–ª—å</th>
                                <th>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="catalogTableBody"></tbody>
                    </table>
                    <div class="empty-state" id="catalogEmptyState">
                        <p>üìö –ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç</p>
                        <p style="font-size: 12px;">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —É–∫–∞–∑–∞—Ç—å —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boxes Tab -->
        <div class="tab-content" id="tab-boxes">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–æ–±–∫–∞–º–∏</h3>
                    <div class="panel-actions">
                        <button class="btn btn-primary btn-sm" onclick="showNewBoxModal()">+ –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ–±–∫—É</button>
                        <button class="btn btn-ghost btn-sm" onclick="printAllLabels()">üè∑Ô∏è –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫</button>
                    </div>
                </div>
                
                <div class="boxes-grid" id="boxesGrid">
                    <div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫</div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div class="tab-content" id="tab-analytics">
            <div class="grid-2">
                <div class="panel">
                    <h3 class="panel-title">üìä –ü–æ —Ü–≤–µ—Ç–∞–º</h3>
                    <div id="colorStats"></div>
                </div>
                <div class="panel">
                    <h3 class="panel-title">üìä –ü–æ —Ä–∞–∑–º–µ—Ä–∞–º</h3>
                    <div id="sizeStats"></div>
                </div>
            </div>
            <div class="panel">
                <h3 class="panel-title">üî¢ –ú–∞—Ç—Ä–∏—Ü–∞: –¶–≤–µ—Ç √ó –†–∞–∑–º–µ—Ä</h3>
                <div class="matrix-container">
                    <table class="matrix" id="matrixTable"></table>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <div class="grid-2">
                <div class="panel">
                    <h3 class="panel-title">üé® –¶–≤–µ—Ç–∞</h3>
                    <div class="color-tags" id="colorTags"></div>
                    <div class="add-inline">
                        <input type="text" id="newColorInput" placeholder="–ù–æ–≤—ã–π —Ü–≤–µ—Ç..." onkeypress="if(event.key==='Enter')addColor()">
                        <button class="btn btn-primary btn-sm" onclick="addColor()">+</button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title">üéØ –ü–ª–∞–Ω</h3>
                    <div class="field">
                        <label>–¶–µ–ª–µ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" id="targetInput" placeholder="0" min="0" onchange="updateTarget()">
                    </div>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title">üîó API –ß–µ—Å—Ç–Ω—ã–π –ó–Ω–∞–∫</h3>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–¥–æ–≤ –≤ –ì–ò–° –ú–¢ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    </p>
                    <div class="field">
                        <label>API Token</label>
                        <input type="text" id="apiTokenInput" placeholder="Bearer ..." onchange="saveApiToken()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="testApiConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title">üì• –ò–º–ø–æ—Ä—Ç</h3>
                    <input type="file" id="importFile" accept=".csv,.xlsx" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">
                        üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (CSV/XLSX)
                    </button>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title">üó£Ô∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="field">
                        <label>–ì–æ–ª–æ—Å</label>
                        <select id="voiceSelect" onchange="saveVoiceSettings()"></select>
                    </div>
                    <div class="field">
                        <label>–°–∫–æ—Ä–æ—Å—Ç—å: <span id="voiceRateValue">1.0</span></label>
                        <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1" 
                               style="width: 100%;" onchange="updateVoiceRate()">
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="testVoice()">üîä –¢–µ—Å—Ç –≥–æ–ª–æ—Å–∞</button>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">üóëÔ∏è –£–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏</h3>
                    <button class="btn btn-danger btn-sm" onclick="clearDeleted()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                </div>
                <div class="deleted-list" id="deletedList">
                    <div class="empty-state">–ù–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalContainer"></div>
    
    <!-- Audio -->
    <audio id="successSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2JkJeLfXB0eYGIiIV+eXl7gIWIhn97eHp+g4eGgn56eXx/g4aEgX57en2Ag4SDgH98fH6BgoOBfn18fX+Cg4GAfn19f4GCgoF/fn1+gIGCgYF/fn5/gIGBgYB/fn9/gIGBgH9/f3+AgIGAf39/f4CAgIB/f39/gICAgH9/f3+AgICAfn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fg==" type="audio/wav">
    </audio>
    <audio id="errorSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRl4EAABXQVZFZm10IBAAAAABAAEAESsAABErAAABAAgAZGF0YToEAACAgICAgICAgH5+fn58fHx6enp4eHh2dnZ0dHRycnJwcHBubm5sbGxqampoaGhmZmZkZGRiYmJgYGBeXl5cXFxaWlpYWFhWVlZWVlZWVlZYWFhaWlpcXFxeXl5gYGBiYmJkZGRmZmZoaGhqampsbGxubm5wcHBycnJ0dHR2dnZ4eHh6enp8fHx+fn6AgICAgICAgIB+fn58fHx6enh4dnZ2dHRycnJwcG5ubmxsampoaGZmZGRiYmBgXl5cXFpaWFhWVlZWVlZWVlhYWlpcXF5eYGBiYmRkZmZoaGpqbGxubm5wcHJydHR2dnh4enp8fH5+gICAgICAgA==" type="audio/wav">
    </audio>

    <script>
        // ============ STATE ============
        let state = {
            sessions: {},
            currentSession: 'default',
            colors: ['–ß–µ—Ä–Ω—ã–π', '–ë–µ–ª—ã–π', '–°–∏–Ω–∏–π'],
            boxes: [],
            gtinBindings: {},
            gtinCatalog: {}, // GTIN -> {color, size, model}
            target: 0,
            soundEnabled: true,
            voiceEnabled: true,
            voiceRate: 1,
            selectedVoice: null,
            deletedRecords: [],
            apiToken: '',
            autoMode: true, // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ GTIN
            workMode: 'receiving', // receiving | inventory | shipping
            streamMode: {
                active: false,
                color: null,
                size: null,
                box: null
            }
        };
        
        // Reconciliation state (not persisted)
        let reconciliation = {
            active: false,
            fileName: '',
            items: [], // {color, size, expected, received}
            rawData: [],
            mapping: { color: null, size: null, qty: null, gtin: null }
        };
        
        let currentSort = { column: null, direction: 'asc' };
        let selectedRecords = new Set();
        let html5QrCode = null;
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            initSizes();
            initVoices();
            renderAll();
            setupEventListeners();
        });
        
        function loadState() {
            const saved = localStorage.getItem('shoeScanner_v2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                } catch (e) {
                    console.error('Load error:', e);
                }
            }
            
            if (!state.sessions[state.currentSession]) {
                state.sessions[state.currentSession] = { name: '–ü–∞—Ä—Ç–∏—è 1', records: [] };
            }
            
            document.getElementById('apiTokenInput').value = state.apiToken || '';
            updateApiStatus();
        }
        
        function saveState() {
            localStorage.setItem('shoeScanner_v2', JSON.stringify(state));
        }
        
        function initVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            
            function populateVoices() {
                const voices = speechSynthesis.getVoices();
                const ruVoices = voices.filter(v => v.lang.startsWith('ru'));
                
                voiceSelect.innerHTML = '';
                (ruVoices.length ? ruVoices : voices).forEach((voice, i) => {
                    const option = new Option(`${voice.name} (${voice.lang})`, i);
                    voiceSelect.add(option);
                });
                
                if (state.selectedVoice !== null) {
                    voiceSelect.value = state.selectedVoice;
                }
            }
            
            populateVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoices;
            }
            
            document.getElementById('voiceRate').value = state.voiceRate;
            document.getElementById('voiceRateValue').textContent = state.voiceRate;
        }
        
        function setupEventListeners() {
            document.addEventListener('keydown', handleHotkeys);
        }
        
        function handleHotkeys(e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ –≤ input/select/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportXLSX(); }
            else if (e.key === 'Delete') { e.preventDefault(); deleteSelected(); }
            else if (e.key.toLowerCase() === 's' && !e.ctrlKey) { e.preventDefault(); toggleStreamMode(); }
        }
        
        // ============ RENDERING ============
        function renderAll() {
            renderColors();
            renderColorSelect();
            renderFilterOptions();
            renderSessions();
            renderBoxes();
            renderBoxSelect();
            renderTable();
            renderStats();
            renderAnalytics();
            renderDeletedList();
            renderCatalog();
            updateProgress();
            updateAutoModeUI();
            updateWorkModeUI();
            if (reconciliation.active) updateReconciliationUI();
            document.getElementById('targetInput').value = state.target || '';
        }
        
        function updateAutoModeUI() {
            const toggle = document.getElementById('autoModeToggle');
            if (toggle) toggle.checked = state.autoMode;
            
            const panel = document.getElementById('autoModePanel');
            const hints = document.querySelectorAll('.auto-hint');
            
            if (state.autoMode) {
                panel.style.borderColor = 'var(--success)';
                panel.style.background = 'rgba(0, 200, 83, 0.1)';
                hints.forEach(h => h.style.display = 'inline');
            } else {
                panel.style.borderColor = 'var(--border)';
                panel.style.background = 'var(--bg-panel)';
                hints.forEach(h => h.style.display = 'none');
            }
        }
        
        // ============ WORK MODES ============
        const workModeConfig = {
            receiving: {
                name: '–ü—Ä–∏—ë–º–∫–∞',
                icon: 'üì•',
                description: '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞',
                color: '#00c853',
                actionText: '–ø—Ä–∏–Ω—è—Ç',
                reportTitle: '–û–¢–ß–Å–¢ –û –ü–†–ò–Å–ú–ö–ï',
                showBoxes: true
            },
            inventory: {
                name: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è',
                icon: 'üìã',
                description: '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞',
                color: '#ffa502',
                actionText: '—É—á—Ç—ë–Ω',
                reportTitle: '–û–¢–ß–Å–¢ –û–ë –ò–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–ò–ò',
                showBoxes: false
            },
            shipping: {
                name: '–û—Ç–ø—Ä–∞–≤–∫–∞',
                icon: 'üì§',
                description: '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏',
                color: '#667eea',
                actionText: '–¥–æ–±–∞–≤–ª–µ–Ω –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ',
                reportTitle: '–û–¢–ß–Å–¢ –û–ë –û–¢–ü–†–ê–í–ö–ï',
                showBoxes: true
            }
        };
        
        function setWorkMode(mode) {
            state.workMode = mode;
            saveState();
            updateWorkModeUI();
            showToast(`–†–µ–∂–∏–º: ${workModeConfig[mode].name}`, 'success');
        }
        
        function updateWorkModeUI() {
            const mode = state.workMode || 'receiving';
            const config = workModeConfig[mode];
            
            // Update buttons
            document.querySelectorAll('.work-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Update info text
            const infoEl = document.getElementById('workModeInfo');
            if (infoEl) {
                infoEl.textContent = config.description;
            }
            
            // Update header badge
            const badge = document.getElementById('workModeBadge');
            if (badge) {
                badge.textContent = `${config.icon} ${config.name}`;
                const gradients = {
                    receiving: 'linear-gradient(135deg, #00c853 0%, #00a844 100%)',
                    inventory: 'linear-gradient(135deg, #ffa502 0%, #e67e00 100%)',
                    shipping: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                };
                badge.style.background = gradients[mode];
            }
            
            // Update panel title
            const panelTitle = document.querySelector('#tab-scan .panel:nth-child(4) .panel-title');
            if (panelTitle) {
                panelTitle.innerHTML = `${config.icon} ${getModeTableTitle()}`;
            }
            
            // Show/hide boxes field based on mode
            const boxField = document.getElementById('boxSelect')?.closest('.field');
            if (boxField) {
                boxField.style.display = config.showBoxes ? 'block' : 'none';
            }
        }
        
        function getModeTableTitle() {
            const mode = state.workMode || 'receiving';
            switch (mode) {
                case 'receiving': return '–ü—Ä–∏–Ω—è—Ç—ã–π —Ç–æ–≤–∞—Ä';
                case 'inventory': return '–£—á—Ç—ë–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä';
                case 'shipping': return '–¢–æ–≤–∞—Ä –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ';
                default: return '–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã';
            }
        }
        
        function getModeActionText() {
            const mode = state.workMode || 'receiving';
            return workModeConfig[mode].actionText;
        }
        
        function generateModeReport() {
            const mode = state.workMode || 'receiving';
            const config = workModeConfig[mode];
            const records = getCurrentRecords();
            
            if (records.length === 0) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–∞', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const useCyrillic = setupCyrillicFont(doc);
            const t = useCyrillic ? (s) => s : transliterate;
            
            // Header with mode-specific styling
            doc.setFontSize(18);
            doc.text(t(config.reportTitle), 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text(`${t('–î–∞—Ç–∞')}: ${new Date().toLocaleDateString('ru-RU')}`, 20, 35);
            doc.text(`${t('–í—Ä–µ–º—è')}: ${new Date().toLocaleTimeString('ru-RU')}`, 20, 42);
            doc.text(`${t('–ú–æ–¥–µ–ª—å')}: Azza Fencing`, 20, 49);
            doc.text(`${t('–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π')}: ${records.length}`, 20, 56);
            
            if (mode === 'shipping' && state.boxes.length > 0) {
                doc.text(`${t('–ö–æ—Ä–æ–±–æ–∫')}: ${state.boxes.length}`, 20, 63);
            }
            
            // Summary by color and size
            const summary = {};
            state.colors.forEach(c => { summary[c] = {}; for(let s=36;s<=47;s++) summary[c][s]=0; });
            records.forEach(r => { if(summary[r.color]) summary[r.color][r.size]++; });
            
            const summaryData = [];
            state.colors.forEach(color => {
                const row = [t(color)];
                let total = 0;
                for(let s=36;s<=47;s++) {
                    row.push(summary[color][s] || '-');
                    total += summary[color][s];
                }
                row.push(total);
                if (total > 0) summaryData.push(row);
            });
            
            const headers = [t('–¶–≤–µ—Ç'), ...Array.from({length:12}, (_,i) => String(36+i)), t('–ò—Ç–æ–≥–æ')];
            
            doc.autoTable({
                startY: mode === 'shipping' ? 73 : 66,
                head: [headers],
                body: summaryData,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2, font: useCyrillic ? 'Roboto' : 'helvetica' },
                headStyles: { fillColor: hexToRgb(config.color) }
            });
            
            // Mode-specific sections
            if (mode === 'shipping' && state.boxes.length > 0) {
                let y = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(14);
                doc.text(t('–°–û–î–ï–†–ñ–ò–ú–û–ï –ö–û–†–û–ë–û–ö'), 20, y);
                y += 10;
                
                state.boxes.forEach(box => {
                    const boxRecords = records.filter(r => r.boxId === box.id);
                    if (boxRecords.length === 0) return;
                    
                    const boxSummary = {};
                    boxRecords.forEach(r => {
                        const key = `${t(r.color)} ${r.size}`;
                        boxSummary[key] = (boxSummary[key] || 0) + 1;
                    });
                    
                    doc.setFontSize(11);
                    doc.text(`${t(box.name)} (${boxRecords.length} ${t('—à—Ç')}.)`, 20, y);
                    y += 5;
                    
                    doc.autoTable({
                        startY: y,
                        head: [[t('–¢–æ–≤–∞—Ä'), t('–ö–æ–ª-–≤–æ')]],
                        body: Object.entries(boxSummary).map(([k, v]) => [k, v]),
                        theme: 'striped',
                        styles: { fontSize: 9, font: useCyrillic ? 'Roboto' : 'helvetica' },
                        headStyles: { fillColor: hexToRgb(config.color) },
                        margin: { left: 25 }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    if (y > 270) { doc.addPage(); y = 20; }
                });
            }
            
            const sessionName = state.sessions[state.currentSession]?.name || 'export';
            const modeNames = { receiving: 'Priemka', inventory: 'Inventarizaciya', shipping: 'Otpravka' };
            doc.save(`${modeNames[mode]}_${t(sessionName)}_${new Date().toISOString().slice(0,10)}.pdf`);
            
            showToast('–û—Ç—á—ë—Ç —Å–æ–∑–¥–∞–Ω', 'success');
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0, 150, 200];
        }
        
        // ============ RECONCILIATION ============
        function handleReconciliationFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            reconciliation.fileName = file.name;
            
            const reader = new FileReader();
            
            if (file.name.match(/\.xlsx?$/i)) {
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        reconciliation.rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        showReconciliationMapping();
                    } catch (err) {
                        showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = text.split(/\r?\n/).map(row => {
                            // Try to detect delimiter
                            if (row.includes(';')) return row.split(';');
                            if (row.includes('\t')) return row.split('\t');
                            return row.split(',');
                        });
                        reconciliation.rawData = rows.filter(r => r.some(cell => cell.trim()));
                        showReconciliationMapping();
                    } catch (err) {
                        showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            event.target.value = '';
        }
        
        function showReconciliationMapping() {
            const data = reconciliation.rawData;
            if (!data || data.length < 2) {
                showToast('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö', 'error');
                return;
            }
            
            document.getElementById('recEmpty').style.display = 'none';
            document.getElementById('recActive').style.display = 'none';
            document.getElementById('recMapping').style.display = 'block';
            document.getElementById('clearRecBtn').style.display = 'none';
            
            // Get headers (first row)
            const headers = data[0].map((h, i) => h || `–°—Ç–æ–ª–±–µ—Ü ${i + 1}`);
            const previewRows = data.slice(1, 6); // First 5 data rows
            
            // Build preview table
            let headHtml = '<tr><th>#</th>';
            headers.forEach((h, i) => {
                headHtml += `<th style="min-width: 100px;">${escapeHtml(String(h))}</th>`;
            });
            headHtml += '</tr>';
            document.getElementById('recPreviewHead').innerHTML = headHtml;
            
            let bodyHtml = '';
            previewRows.forEach((row, rowIdx) => {
                bodyHtml += `<tr><td>${rowIdx + 1}</td>`;
                headers.forEach((_, colIdx) => {
                    const val = row[colIdx] !== undefined ? row[colIdx] : '';
                    bodyHtml += `<td>${escapeHtml(String(val))}</td>`;
                });
                bodyHtml += '</tr>';
            });
            document.getElementById('recPreviewBody').innerHTML = bodyHtml;
            
            // Build mapping selects
            const fields = [
                { key: 'color', label: '–¶–≤–µ—Ç', required: true },
                { key: 'size', label: '–†–∞–∑–º–µ—Ä', required: true },
                { key: 'qty', label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', required: true },
                { key: 'gtin', label: 'GTIN (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', required: false }
            ];
            
            let selectsHtml = '';
            fields.forEach(field => {
                selectsHtml += `
                    <div class="field">
                        <label>${field.label} ${field.required ? '*' : ''}</label>
                        <select id="recMap_${field.key}">
                            <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                            ${headers.map((h, i) => `<option value="${i}">${escapeHtml(String(h))}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            document.getElementById('recMappingSelects').innerHTML = selectsHtml;
            
            // Try to auto-detect columns
            autoDetectColumns(headers);
        }
        
        function autoDetectColumns(headers) {
            const lowerHeaders = headers.map(h => String(h).toLowerCase());
            
            // Color detection
            const colorPatterns = ['—Ü–≤–µ—Ç', 'color', '—Ü–≤.', '—Ü–≤'];
            const colorIdx = lowerHeaders.findIndex(h => colorPatterns.some(p => h.includes(p)));
            if (colorIdx !== -1) document.getElementById('recMap_color').value = colorIdx;
            
            // Size detection
            const sizePatterns = ['—Ä–∞–∑–º–µ—Ä', 'size', '—Ä–∞–∑–º', '—Ä–∞–∑–º.', '—Ä.', '—Ä-—Ä'];
            const sizeIdx = lowerHeaders.findIndex(h => sizePatterns.some(p => h.includes(p)));
            if (sizeIdx !== -1) document.getElementById('recMap_size').value = sizeIdx;
            
            // Quantity detection
            const qtyPatterns = ['–∫–æ–ª', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'qty', '—à—Ç', 'count', '–∫–æ–ª-–≤–æ'];
            const qtyIdx = lowerHeaders.findIndex(h => qtyPatterns.some(p => h.includes(p)));
            if (qtyIdx !== -1) document.getElementById('recMap_qty').value = qtyIdx;
            
            // GTIN detection
            const gtinPatterns = ['gtin', '—à—Ç—Ä–∏—Ö–∫–æ–¥', 'ean', 'barcode', '—à—Ç—Ä–∏—Ö'];
            const gtinIdx = lowerHeaders.findIndex(h => gtinPatterns.some(p => h.includes(p)));
            if (gtinIdx !== -1) document.getElementById('recMap_gtin').value = gtinIdx;
        }
        
        function applyReconciliationMapping() {
            const colorCol = document.getElementById('recMap_color').value;
            const sizeCol = document.getElementById('recMap_size').value;
            const qtyCol = document.getElementById('recMap_qty').value;
            const gtinCol = document.getElementById('recMap_gtin').value;
            
            if (colorCol === '' || sizeCol === '' || qtyCol === '') {
                showToast('–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–ª–±—Ü—ã: –¶–≤–µ—Ç, –†–∞–∑–º–µ—Ä, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
                return;
            }
            
            reconciliation.mapping = {
                color: parseInt(colorCol),
                size: parseInt(sizeCol),
                qty: parseInt(qtyCol),
                gtin: gtinCol !== '' ? parseInt(gtinCol) : null
            };
            
            // Parse data into items
            const data = reconciliation.rawData.slice(1); // Skip header
            reconciliation.items = [];
            
            const grouped = {};
            
            data.forEach(row => {
                const color = String(row[reconciliation.mapping.color] || '').trim();
                const size = String(row[reconciliation.mapping.size] || '').trim();
                const qty = parseInt(row[reconciliation.mapping.qty]) || 0;
                
                if (!color || !size || qty <= 0) return;
                
                const key = `${color}|${size}`;
                if (!grouped[key]) {
                    grouped[key] = { color, size, expected: 0, received: 0 };
                }
                grouped[key].expected += qty;
                
                // Add color to state if not exists
                if (!state.colors.includes(color)) {
                    state.colors.push(color);
                    saveState();
                }
            });
            
            reconciliation.items = Object.values(grouped);
            reconciliation.active = true;
            
            // Show active reconciliation
            document.getElementById('recMapping').style.display = 'none';
            document.getElementById('recActive').style.display = 'block';
            document.getElementById('clearRecBtn').style.display = 'inline-flex';
            
            updateReconciliationUI();
            renderColors();
            renderColorSelect();
            
            showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${reconciliation.items.length} –ø–æ–∑–∏—Ü–∏–π`, 'success');
        }
        
        function cancelReconciliationMapping() {
            document.getElementById('recMapping').style.display = 'none';
            document.getElementById('recEmpty').style.display = 'block';
            reconciliation.rawData = [];
        }
        
        function updateReconciliationUI() {
            if (!reconciliation.active) {
                document.getElementById('recIndicator').classList.remove('active');
                return;
            }
            
            // Update received counts from current records
            const records = getCurrentRecords();
            reconciliation.items.forEach(item => {
                item.received = records.filter(r => 
                    r.color === item.color && String(r.size) === String(item.size)
                ).length;
            });
            
            // Calculate totals
            const totalExpected = reconciliation.items.reduce((sum, i) => sum + i.expected, 0);
            const totalReceived = reconciliation.items.reduce((sum, i) => sum + Math.min(i.received, i.expected), 0);
            const totalMissing = reconciliation.items.reduce((sum, i) => sum + Math.max(0, i.expected - i.received), 0);
            const totalExtra = reconciliation.items.reduce((sum, i) => sum + Math.max(0, i.received - i.expected), 0);
            
            // Update summary
            document.getElementById('recFileName').textContent = reconciliation.fileName;
            document.getElementById('recExpected').textContent = totalExpected;
            document.getElementById('recReceived').textContent = totalReceived;
            document.getElementById('recMissing').textContent = totalMissing;
            document.getElementById('recExtra').textContent = totalExtra;
            
            // Progress
            const progress = totalExpected > 0 ? Math.round((totalReceived / totalExpected) * 100) : 0;
            document.getElementById('recProgressText').textContent = progress + '%';
            document.getElementById('recProgressBar').style.width = progress + '%';
            
            if (totalMissing === 0 && totalExtra === 0) {
                document.getElementById('recProgressBar').style.background = 'var(--success)';
            } else if (totalExtra > 0) {
                document.getElementById('recProgressBar').style.background = 'linear-gradient(90deg, var(--success), var(--warning))';
            }
            
            // Update items table
            let tableHtml = '';
            reconciliation.items.forEach(item => {
                const diff = item.received - item.expected;
                let status, statusClass;
                
                if (diff === 0 && item.received > 0) {
                    status = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                    statusClass = 'done';
                } else if (diff > 0) {
                    status = `‚ö†Ô∏è +${diff} –ª–∏—à–Ω–∏—Ö`;
                    statusClass = 'extra';
                } else if (item.received > 0) {
                    status = `‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ`;
                    statusClass = 'partial';
                } else {
                    status = `‚ùå –ù–µ—Ç`;
                    statusClass = 'missing';
                }
                
                tableHtml += `
                    <tr>
                        <td><span class="rec-status ${statusClass}">${status}</span></td>
                        <td>${escapeHtml(item.color)}</td>
                        <td>${item.size}</td>
                        <td>${item.expected}</td>
                        <td>${item.received}</td>
                        <td style="color: ${diff > 0 ? 'var(--warning)' : diff < 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">
                            ${diff > 0 ? '+' : ''}${diff}
                        </td>
                    </tr>
                `;
            });
            document.getElementById('recItemsBody').innerHTML = tableHtml;
            
            // Update indicator
            const indicator = document.getElementById('recIndicator');
            indicator.classList.add('active');
            document.getElementById('recIndicatorText').textContent = `${totalReceived}/${totalExpected}`;
        }
        
        function clearReconciliation() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä–∫–∏?')) return;
            
            reconciliation = {
                active: false,
                fileName: '',
                items: [],
                rawData: [],
                mapping: { color: null, size: null, qty: null, gtin: null }
            };
            
            document.getElementById('recEmpty').style.display = 'block';
            document.getElementById('recMapping').style.display = 'none';
            document.getElementById('recActive').style.display = 'none';
            document.getElementById('clearRecBtn').style.display = 'none';
            document.getElementById('recIndicator').classList.remove('active');
            
            showToast('–°–≤–µ—Ä–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
        }
        
        function checkReconciliation(color, size) {
            if (!reconciliation.active) return { status: 'ok', message: null };
            
            const item = reconciliation.items.find(i => 
                i.color === color && String(i.size) === String(size)
            );
            
            if (!item) {
                return { status: 'not_in_list', message: `‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–∫–ª–∞–¥–Ω–æ–π: ${color} ${size}` };
            }
            
            if (item.received >= item.expected) {
                return { status: 'extra', message: `‚ö†Ô∏è –õ–∏—à–Ω–∏–π! –í –Ω–∞–∫–ª–∞–¥–Ω–æ–π —Ç–æ–ª—å–∫–æ ${item.expected} —à—Ç.` };
            }
            
            return { status: 'ok', message: null };
        }
        
        function generateReconciliationReport() {
            if (!reconciliation.active || reconciliation.items.length === 0) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–∞', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const useCyrillic = setupCyrillicFont(doc);
            const t = useCyrillic ? (s) => s : transliterate;
            
            // Header
            doc.setFontSize(18);
            doc.text(t('–ê–ö–¢ –°–í–ï–†–ö–ò'), 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text(`${t('–î–∞—Ç–∞')}: ${new Date().toLocaleDateString('ru-RU')}`, 20, 35);
            doc.text(`${t('–ù–∞–∫–ª–∞–¥–Ω–∞—è')}: ${reconciliation.fileName}`, 20, 42);
            
            // Summary
            const totalExpected = reconciliation.items.reduce((sum, i) => sum + i.expected, 0);
            const totalReceived = reconciliation.items.reduce((sum, i) => sum + i.received, 0);
            const totalMissing = reconciliation.items.reduce((sum, i) => sum + Math.max(0, i.expected - i.received), 0);
            const totalExtra = reconciliation.items.reduce((sum, i) => sum + Math.max(0, i.received - i.expected), 0);
            
            doc.text(`${t('–û–∂–∏–¥–∞–ª–æ—Å—å')}: ${totalExpected} ${t('—à—Ç')}.`, 20, 52);
            doc.text(`${t('–ü—Ä–∏–Ω—è—Ç–æ')}: ${totalReceived} ${t('—à—Ç')}.`, 20, 59);
            doc.text(`${t('–ù–µ–¥–æ—Å—Ç–∞—á–∞')}: ${totalMissing} ${t('—à—Ç')}.`, 20, 66);
            doc.text(`${t('–ò–∑–ª–∏—à–∫–∏')}: ${totalExtra} ${t('—à—Ç')}.`, 20, 73);
            
            // Discrepancies table
            const discrepancies = reconciliation.items.filter(i => i.received !== i.expected);
            
            if (discrepancies.length > 0) {
                doc.setFontSize(14);
                doc.text(t('–†–ê–°–•–û–ñ–î–ï–ù–ò–Ø'), 20, 88);
                
                const tableData = discrepancies.map(item => {
                    const diff = item.received - item.expected;
                    return [
                        t(item.color),
                        item.size,
                        item.expected,
                        item.received,
                        (diff > 0 ? '+' : '') + diff
                    ];
                });
                
                doc.autoTable({
                    startY: 93,
                    head: [[t('–¶–≤–µ—Ç'), t('–†–∞–∑–º–µ—Ä'), t('–û–∂–∏–¥–∞–ª–æ—Å—å'), t('–ü—Ä–∏–Ω—è—Ç–æ'), t('–†–∞–∑–Ω–∏—Ü–∞')]],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 10, font: useCyrillic ? 'Roboto' : 'helvetica' },
                    headStyles: { fillColor: [255, 71, 87] }
                });
            } else {
                doc.setFontSize(14);
                doc.setTextColor(0, 200, 83);
                doc.text(t('–í–°–ï –ü–û–ó–ò–¶–ò–ò –°–û–í–ü–ê–î–ê–Æ–¢'), 105, 88, { align: 'center' });
                doc.setTextColor(0, 0, 0);
            }
            
            // Signatures
            const y = discrepancies.length > 0 ? doc.lastAutoTable.finalY + 30 : 110;
            doc.setFontSize(10);
            doc.text(`${t('–°–¥–∞–ª')}: ___________________ / ___________________`, 20, y);
            doc.text(`${t('–ü—Ä–∏–Ω—è–ª')}: ___________________ / ___________________`, 20, y + 15);
            
            doc.save(`Akt_sverki_${new Date().toISOString().slice(0,10)}.pdf`);
            showToast('–ê–∫—Ç —Å–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞–Ω', 'success');
        }
        
        function renderColors() {
            document.getElementById('colorTags').innerHTML = state.colors.map(color => `
                <div class="color-tag">
                    ${escapeHtml(color)}
                    <span class="remove" onclick="removeColor('${escapeHtml(color)}')">&times;</span>
                </div>
            `).join('');
        }
        
        function renderColorSelect() {
            const select = document.getElementById('colorSelect');
            const currentValue = select.value;
            
            const defaultOption = state.autoMode ? '‚Äî –ê–≤—Ç–æ ‚Äî' : '‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî';
            select.innerHTML = `<option value="">${defaultOption}</option>`;
            state.colors.forEach(c => select.add(new Option(c, c)));
            if (state.colors.includes(currentValue)) select.value = currentValue;
        }
        
        function initSizes() {
            const sizeSelect = document.getElementById('sizeSelect');
            const filterSize = document.getElementById('filterSize');
            
            const defaultOption = state.autoMode ? '‚Äî –ê–≤—Ç–æ ‚Äî' : '‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî';
            sizeSelect.innerHTML = `<option value="">${defaultOption}</option>`;
            
            for (let size = 36; size <= 47; size++) {
                sizeSelect.add(new Option(size, size));
                filterSize.add(new Option(size, size));
            }
        }
        
        function renderFilterOptions() {
            const filterColor = document.getElementById('filterColor');
            const filterBox = document.getElementById('filterBox');
            
            filterColor.innerHTML = '<option value="">–í—Å–µ —Ü–≤–µ—Ç–∞</option>';
            state.colors.forEach(c => filterColor.add(new Option(c, c)));
            
            filterBox.innerHTML = '<option value="">–í—Å–µ –∫–æ—Ä–æ–±–∫–∏</option>';
            filterBox.add(new Option('–ë–µ–∑ –∫–æ—Ä–æ–±–∫–∏', '__none__'));
            state.boxes.forEach(b => filterBox.add(new Option(b.name, b.id)));
        }
        
        function renderSessions() {
            const select = document.getElementById('sessionSelect');
            select.innerHTML = '';
            Object.keys(state.sessions).forEach(key => {
                const option = new Option(state.sessions[key].name, key);
                if (key === state.currentSession) option.selected = true;
                select.add(option);
            });
        }
        
        function renderBoxSelect() {
            const select = document.getElementById('boxSelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">‚Äî –ë–µ–∑ –∫–æ—Ä–æ–±–∫–∏ ‚Äî</option>';
            state.boxes.forEach(box => {
                const count = getCurrentRecords().filter(r => r.boxId === box.id).length;
                const isFull = box.capacity > 0 && count >= box.capacity;
                const option = new Option(`${box.name} (${count}/${box.capacity || '‚àû'})${isFull ? ' ‚úì' : ''}`, box.id);
                if (isFull) option.disabled = true;
                select.add(option);
            });
            if (currentValue) select.value = currentValue;
        }
        
        function renderBoxes() {
            const grid = document.getElementById('boxesGrid');
            
            if (state.boxes.length === 0) {
                grid.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫</div>';
                return;
            }
            
            grid.innerHTML = state.boxes.map(box => {
                const records = getCurrentRecords().filter(r => r.boxId === box.id);
                const count = records.length;
                const isFull = box.capacity > 0 && count >= box.capacity;
                const percent = box.capacity > 0 ? Math.min(100, (count / box.capacity) * 100) : 0;
                
                // Summarize contents
                const summary = {};
                records.forEach(r => {
                    const key = `${r.color} ${r.size}`;
                    summary[key] = (summary[key] || 0) + 1;
                });
                const contentsStr = Object.entries(summary).map(([k, v]) => `${k}: ${v}`).join(', ');
                
                return `
                    <div class="box-card ${isFull ? 'full' : ''}">
                        <div class="box-header">
                            <span class="box-name">üì¶ ${escapeHtml(box.name)}</span>
                            <span class="box-count ${isFull ? 'full' : ''}">${count} / ${box.capacity || '‚àû'}</span>
                        </div>
                        <div class="box-body">
                            ${box.capacity > 0 ? `
                                <div class="box-progress">
                                    <div class="box-progress-fill ${isFull ? 'full' : ''}" style="width: ${percent}%"></div>
                                </div>
                            ` : ''}
                            <div class="box-contents">${contentsStr || '–ü—É—Å—Ç–æ'}</div>
                            <div class="box-actions">
                                <button class="btn btn-ghost btn-sm" onclick="printBoxLabel('${box.id}')">üè∑Ô∏è –≠—Ç–∏–∫–µ—Ç–∫–∞</button>
                                <button class="btn btn-ghost btn-sm" onclick="editBox('${box.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteBox('${box.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCurrentRecords() {
            return state.sessions[state.currentSession]?.records || [];
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            
            let records = getCurrentRecords();
            
            // Apply filters
            const search = document.getElementById('searchInput').value.toLowerCase();
            const colorFilter = document.getElementById('filterColor').value;
            const sizeFilter = document.getElementById('filterSize').value;
            const boxFilter = document.getElementById('filterBox').value;
            
            records = records.filter(r => {
                if (search && !r.gtin.includes(search) && !r.fullCode.toLowerCase().includes(search)) return false;
                if (colorFilter && r.color !== colorFilter) return false;
                if (sizeFilter && r.size != sizeFilter) return false;
                if (boxFilter === '__none__' && r.boxId) return false;
                if (boxFilter && boxFilter !== '__none__' && r.boxId !== boxFilter) return false;
                return true;
            });
            
            // Apply sorting
            if (currentSort.column) {
                records = [...records].sort((a, b) => {
                    let valA = a[currentSort.column];
                    let valB = b[currentSort.column];
                    if (currentSort.column === 'index') {
                        valA = getCurrentRecords().indexOf(a);
                        valB = getCurrentRecords().indexOf(b);
                    } else if (currentSort.column === 'size') {
                        valA = parseInt(valA); valB = parseInt(valB);
                    }
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            if (records.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = records.map((record) => {
                const idx = getCurrentRecords().indexOf(record);
                const box = state.boxes.find(b => b.id === record.boxId);
                const isSelected = selectedRecords.has(idx);
                
                return `
                    <tr class="${isSelected ? 'selected' : ''}">
                        <td class="checkbox-cell">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRecordSelection(${idx})">
                        </td>
                        <td class="row-num">${idx + 1}</td>
                        <td>${escapeHtml(record.color)}</td>
                        <td>${record.size}</td>
                        <td>${box ? escapeHtml(box.name) : '-'}</td>
                        <td class="gtin-cell">${record.gtin}</td>
                        <td class="code-cell">${escapeHtml(record.shortCode)}</td>
                        <td>
                            <span class="status-badge status-${record.status || 'unknown'}">
                                ${getStatusText(record.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord(${idx})">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateSelectedCount();
        }
        
        function getStatusText(status) {
            const texts = {
                'unknown': '?',
                'checking': '...',
                'valid': '–í –æ–±–æ—Ä–æ—Ç–µ',
                'invalid': '–í—ã–±—ã–ª'
            };
            return texts[status] || '?';
        }
        
        function renderStats() {
            const records = getCurrentRecords();
            const mode = state.workMode || 'receiving';
            const config = workModeConfig[mode];
            
            const colorCounts = {};
            state.colors.forEach(c => colorCounts[c] = 0);
            records.forEach(r => { if (colorCounts[r.color] !== undefined) colorCounts[r.color]++; });
            
            let html = `<div class="stat-card">
                <div class="stat-value" style="color: ${config.color};">${records.length}</div>
                <div class="stat-label">${config.icon} ${config.name}</div>
            </div>`;
            
            state.colors.forEach(c => {
                html += `<div class="stat-card"><div class="stat-value">${colorCounts[c]}</div><div class="stat-label">${escapeHtml(c)}</div></div>`;
            });
            
            if (config.showBoxes) {
                html += `<div class="stat-card"><div class="stat-value">${state.boxes.length}</div><div class="stat-label">–ö–æ—Ä–æ–±–æ–∫</div></div>`;
            }
            
            document.getElementById('statsGrid').innerHTML = html;
        }
        
        function renderAnalytics() {
            const records = getCurrentRecords();
            
            // By color
            const colorStats = {};
            state.colors.forEach(c => colorStats[c] = 0);
            records.forEach(r => { if (colorStats[r.color] !== undefined) colorStats[r.color]++; });
            
            let colorHtml = '<div class="stats-grid">';
            Object.entries(colorStats).forEach(([color, count]) => {
                const percent = records.length ? Math.round(count / records.length * 100) : 0;
                colorHtml += `<div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">${escapeHtml(color)} (${percent}%)</div></div>`;
            });
            colorHtml += '</div>';
            document.getElementById('colorStats').innerHTML = colorHtml;
            
            // By size
            const sizeStats = {};
            for (let s = 36; s <= 47; s++) sizeStats[s] = 0;
            records.forEach(r => { if (sizeStats[r.size] !== undefined) sizeStats[r.size]++; });
            
            let sizeHtml = '<div class="stats-grid">';
            Object.entries(sizeStats).forEach(([size, count]) => {
                sizeHtml += `<div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">–†–∞–∑–º–µ—Ä ${size}</div></div>`;
            });
            sizeHtml += '</div>';
            document.getElementById('sizeStats').innerHTML = sizeHtml;
            
            // Matrix
            const matrix = {};
            state.colors.forEach(color => {
                matrix[color] = {};
                for (let s = 36; s <= 47; s++) matrix[color][s] = 0;
            });
            records.forEach(r => { if (matrix[r.color]) matrix[r.color][r.size]++; });
            
            const sizes = [];
            for (let s = 36; s <= 47; s++) sizes.push(s);
            
            let matrixHtml = '<thead><tr><th>–¶–≤–µ—Ç \\ –†–∞–∑–º–µ—Ä</th>';
            sizes.forEach(s => matrixHtml += `<th>${s}</th>`);
            matrixHtml += '<th>–ò—Ç–æ–≥–æ</th></tr></thead><tbody>';
            
            state.colors.forEach(color => {
                let rowTotal = 0;
                matrixHtml += `<tr><th>${escapeHtml(color)}</th>`;
                sizes.forEach(s => {
                    const c = matrix[color][s];
                    rowTotal += c;
                    matrixHtml += `<td class="${c > 0 ? 'has-items' : ''}">${c || '-'}</td>`;
                });
                matrixHtml += `<td class="has-items">${rowTotal}</td></tr>`;
            });
            
            matrixHtml += '<tr><th>–ò—Ç–æ–≥–æ</th>';
            let grandTotal = 0;
            sizes.forEach(s => {
                let colTotal = 0;
                state.colors.forEach(c => colTotal += matrix[c][s]);
                grandTotal += colTotal;
                matrixHtml += `<td class="${colTotal > 0 ? 'has-items' : ''}">${colTotal || '-'}</td>`;
            });
            matrixHtml += `<td class="has-items">${grandTotal}</td></tr></tbody>`;
            
            document.getElementById('matrixTable').innerHTML = matrixHtml;
        }
        
        function renderDeletedList() {
            const container = document.getElementById('deletedList');
            if (state.deletedRecords.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</div>';
                return;
            }
            container.innerHTML = state.deletedRecords.map((r, i) => `
                <div class="deleted-item" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-panel);border-radius:8px;margin-bottom:6px;font-size:12px;">
                    <span>${escapeHtml(r.color)} | ${r.size} | ${r.gtin}</span>
                    <button class="btn btn-success btn-sm" onclick="restoreRecord(${i})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `).join('');
        }
        
        // ============ CATALOG ============
        function renderCatalog() {
            const tbody = document.getElementById('catalogTableBody');
            const emptyState = document.getElementById('catalogEmptyState');
            const searchInput = document.getElementById('catalogSearch');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            
            const entries = Object.entries(state.gtinCatalog);
            
            // Update counts
            document.getElementById('catalogCount').textContent = entries.length;
            document.getElementById('catalogTotalCount').textContent = entries.length;
            
            // Filter by search
            const filtered = entries.filter(([gtin, data]) => {
                if (!search) return true;
                return gtin.includes(search) || 
                       data.color.toLowerCase().includes(search) ||
                       String(data.size).includes(search);
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filtered.map(([gtin, data]) => `
                <tr>
                    <td class="gtin-cell">${gtin}</td>
                    <td>${escapeHtml(data.color)}</td>
                    <td>${data.size}</td>
                    <td>${escapeHtml(data.model || 'Azza Fencing')}</td>
                    <td>${data.scanCount || 0}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="editCatalogEntry('${gtin}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCatalogEntry('${gtin}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddGtinModal() {
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å GTIN –≤ –∫–∞—Ç–∞–ª–æ–≥</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="field">
                            <label>GTIN (14 —Ü–∏—Ñ—Ä)</label>
                            <input type="text" id="addGtinValue" maxlength="14" placeholder="04610456230546">
                        </div>
                        <div class="grid-2" style="gap: 12px;">
                            <div class="field">
                                <label>–¶–≤–µ—Ç</label>
                                <select id="addGtinColor">
                                    ${state.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="field">
                                <label>–†–∞–∑–º–µ—Ä</label>
                                <select id="addGtinSize">
                                    ${Array.from({length: 12}, (_, i) => 36 + i).map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addCatalogEntry()" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function addCatalogEntry() {
            const gtin = document.getElementById('addGtinValue').value.trim();
            const color = document.getElementById('addGtinColor').value;
            const size = document.getElementById('addGtinSize').value;
            
            if (!gtin || gtin.length !== 14 || !/^\d+$/.test(gtin)) {
                showToast('GTIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 14 —Ü–∏—Ñ—Ä', 'error');
                return;
            }
            
            if (state.gtinCatalog[gtin]) {
                showToast('–≠—Ç–æ—Ç GTIN —É–∂–µ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ', 'warning');
                return;
            }
            
            state.gtinCatalog[gtin] = {
                color,
                size,
                model: 'Azza Fencing',
                addedAt: new Date().toISOString(),
                scanCount: 0
            };
            
            saveState();
            closeModal();
            renderCatalog();
            showToast('GTIN –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥', 'success');
        }
        
        function editCatalogEntry(gtin) {
            const entry = state.gtinCatalog[gtin];
            if (!entry) return;
            
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å GTIN</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div style="background: var(--bg-panel); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-family: monospace;">
                            GTIN: <strong style="color: #ffd700;">${gtin}</strong>
                        </div>
                        <div class="grid-2" style="gap: 12px;">
                            <div class="field">
                                <label>–¶–≤–µ—Ç</label>
                                <select id="editGtinColor">
                                    ${state.colors.map(c => `<option value="${c}" ${c === entry.color ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="field">
                                <label>–†–∞–∑–º–µ—Ä</label>
                                <select id="editGtinSize">
                                    ${Array.from({length: 12}, (_, i) => 36 + i).map(s => `<option value="${s}" ${s == entry.size ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveCatalogEntry('${gtin}')" style="margin-top: 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function saveCatalogEntry(gtin) {
            const color = document.getElementById('editGtinColor').value;
            const size = document.getElementById('editGtinSize').value;
            
            state.gtinCatalog[gtin].color = color;
            state.gtinCatalog[gtin].size = size;
            
            saveState();
            closeModal();
            renderCatalog();
            showToast('GTIN –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        }
        
        function deleteCatalogEntry(gtin) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å GTIN ${gtin} –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞?`)) return;
            
            delete state.gtinCatalog[gtin];
            saveState();
            renderCatalog();
            showToast('GTIN —É–¥–∞–ª—ë–Ω –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞', 'success');
        }
        
        function exportCatalog() {
            const data = JSON.stringify(state.gtinCatalog, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gtin_catalog_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            showToast('–ö–∞—Ç–∞–ª–æ–≥ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
        }
        
        function importCatalog(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;
                    
                    Object.entries(data).forEach(([gtin, entry]) => {
                        if (!state.gtinCatalog[gtin]) {
                            state.gtinCatalog[gtin] = entry;
                            imported++;
                        }
                    });
                    
                    saveState();
                    renderCatalog();
                    showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported} GTIN`, 'success');
                } catch (err) {
                    showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function toggleAutoMode() {
            state.autoMode = document.getElementById('autoModeToggle').checked;
            
            const panel = document.getElementById('autoModePanel');
            const hints = document.querySelectorAll('.auto-hint');
            
            if (state.autoMode) {
                panel.style.borderColor = 'var(--success)';
                panel.style.background = 'rgba(0, 200, 83, 0.1)';
                hints.forEach(h => h.style.display = 'inline');
                document.getElementById('colorSelect').innerHTML = '<option value="">‚Äî –ê–≤—Ç–æ ‚Äî</option>' + 
                    state.colors.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('sizeSelect').innerHTML = '<option value="">‚Äî –ê–≤—Ç–æ ‚Äî</option>' + 
                    Array.from({length: 12}, (_, i) => 36 + i).map(s => `<option value="${s}">${s}</option>`).join('');
            } else {
                panel.style.borderColor = 'var(--border)';
                panel.style.background = 'var(--bg-panel)';
                hints.forEach(h => h.style.display = 'none');
                document.getElementById('colorSelect').innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + 
                    state.colors.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('sizeSelect').innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + 
                    Array.from({length: 12}, (_, i) => 36 + i).map(s => `<option value="${s}">${s}</option>`).join('');
            }
            
            saveState();
            showToast(state.autoMode ? '–ê–≤—Ç–æ—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω' : '–ê–≤—Ç–æ—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'success');
        }
        
        // ============ MOYSKLAD CONVEYOR ============
        let moySkladState = {
            nomenclatures: [],      // Array of {key, color, size, codes[]}
            currentNomIndex: 0,     // Current nomenclature index
            currentCodeIndex: 0,    // Current code index within nomenclature
            copiedCodes: new Set(), // Track copied codes
            totalCopied: 0
        };
        
        function initMoySklad() {
            const records = getCurrentRecords();
            
            if (records.length === 0) {
                document.getElementById('moyskladEmpty').style.display = 'block';
                document.getElementById('moyskladContent').style.display = 'none';
                return;
            }
            
            document.getElementById('moyskladEmpty').style.display = 'none';
            document.getElementById('moyskladContent').style.display = 'block';
            
            // Group records by nomenclature (color + size)
            const grouped = {};
            records.forEach(r => {
                const key = `${r.color}|${r.size}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        key,
                        color: r.color,
                        size: r.size,
                        codes: []
                    };
                }
                grouped[key].codes.push(r.shortCode);
            });
            
            moySkladState.nomenclatures = Object.values(grouped).sort((a, b) => {
                if (a.color !== b.color) return a.color.localeCompare(b.color);
                return parseInt(a.size) - parseInt(b.size);
            });
            
            renderNomenclatureList();
            renderConveyor();
            updateMoySkladStats();
        }
        
        function renderNomenclatureList() {
            const container = document.getElementById('nomenclatureList');
            
            container.innerHTML = moySkladState.nomenclatures.map((nom, index) => {
                const isActive = index === moySkladState.currentNomIndex;
                const isDone = isNomenclatureDone(index);
                
                let style = `
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s;
                    border: 2px solid;
                `;
                
                if (isDone) {
                    style += 'background: var(--success); border-color: var(--success); color: #fff;';
                } else if (isActive) {
                    style += 'background: var(--accent); border-color: var(--accent); color: #000;';
                } else {
                    style += 'background: var(--bg-panel); border-color: var(--border); color: var(--text-primary);';
                }
                
                return `
                    <div style="${style}" onclick="selectNomenclature(${index})">
                        ${isDone ? '‚úì ' : ''}${escapeHtml(nom.color)}, ${nom.size}
                        <span style="opacity: 0.7; margin-left: 4px;">(${nom.codes.length})</span>
                    </div>
                `;
            }).join('');
        }
        
        function isNomenclatureDone(nomIndex) {
            const nom = moySkladState.nomenclatures[nomIndex];
            if (!nom) return false;
            return nom.codes.every(code => moySkladState.copiedCodes.has(code));
        }
        
        function selectNomenclature(index) {
            moySkladState.currentNomIndex = index;
            moySkladState.currentCodeIndex = 0;
            
            // Find first uncopied code
            const nom = moySkladState.nomenclatures[index];
            if (nom) {
                const firstUncopied = nom.codes.findIndex(code => !moySkladState.copiedCodes.has(code));
                if (firstUncopied !== -1) {
                    moySkladState.currentCodeIndex = firstUncopied;
                }
            }
            
            renderNomenclatureList();
            renderConveyor();
        }
        
        function renderConveyor() {
            const nom = moySkladState.nomenclatures[moySkladState.currentNomIndex];
            
            const container = document.getElementById('conveyorContainer');
            const complete = document.getElementById('conveyorComplete');
            const allDone = document.getElementById('conveyorAllDone');
            
            // Check if all done
            if (moySkladState.nomenclatures.every((_, i) => isNomenclatureDone(i))) {
                container.style.display = 'none';
                complete.style.display = 'none';
                allDone.style.display = 'block';
                document.getElementById('allDoneCount').textContent = moySkladState.totalCopied;
                return;
            }
            
            // Check if current nomenclature is done
            if (!nom || isNomenclatureDone(moySkladState.currentNomIndex)) {
                container.style.display = 'none';
                complete.style.display = 'block';
                allDone.style.display = 'none';
                document.getElementById('completedNomenclature').textContent = 
                    nom ? `${nom.color}, —Ä–∞–∑–º–µ—Ä ${nom.size} ‚Äî ${nom.codes.length} —à—Ç.` : '';
                return;
            }
            
            container.style.display = 'block';
            complete.style.display = 'none';
            allDone.style.display = 'none';
            
            const currentCode = nom.codes[moySkladState.currentCodeIndex];
            
            document.getElementById('conveyorNomenclature').textContent = 
                `üì¶ ${nom.color}, —Ä–∞–∑–º–µ—Ä ${nom.size}`;
            document.getElementById('conveyorCurrentNum').textContent = 
                moySkladState.currentCodeIndex + 1;
            document.getElementById('conveyorTotalNum').textContent = nom.codes.length;
            document.getElementById('conveyorCode').textContent = currentCode;
            
            // Progress dots
            const dotsHtml = nom.codes.map((code, i) => {
                const isCopied = moySkladState.copiedCodes.has(code);
                const isCurrent = i === moySkladState.currentCodeIndex;
                
                let dotStyle = `
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    transition: all 0.2s;
                `;
                
                if (isCopied) {
                    dotStyle += 'background: var(--success);';
                } else if (isCurrent) {
                    dotStyle += 'background: var(--accent); box-shadow: 0 0 8px var(--accent);';
                } else {
                    dotStyle += 'background: var(--bg-panel); border: 1px solid var(--border);';
                }
                
                return `<div style="${dotStyle}"></div>`;
            }).join('');
            
            document.getElementById('conveyorProgress').innerHTML = dotsHtml;
        }
        
        async function copyAndNext() {
            const nom = moySkladState.nomenclatures[moySkladState.currentNomIndex];
            if (!nom) return;
            
            const currentCode = nom.codes[moySkladState.currentCodeIndex];
            
            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(currentCode);
                
                // Mark as copied
                moySkladState.copiedCodes.add(currentCode);
                moySkladState.totalCopied++;
                
                // Visual feedback
                const btn = document.getElementById('conveyorButton');
                btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.style.background = 'var(--success)';
                
                playSound('success');
                
                setTimeout(() => {
                    btn.textContent = 'üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ò –î–ê–õ–¨–®–ï';
                    btn.style.background = '';
                    
                    // Move to next code
                    moySkladState.currentCodeIndex++;
                    
                    // If end of nomenclature, show complete screen
                    if (moySkladState.currentCodeIndex >= nom.codes.length) {
                        renderConveyor();
                        renderNomenclatureList();
                    } else {
                        renderConveyor();
                    }
                    
                    updateMoySkladStats();
                }, 300);
                
            } catch (err) {
                showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }
        
        function nextNomenclature() {
            // Find next incomplete nomenclature
            let nextIndex = moySkladState.currentNomIndex + 1;
            
            while (nextIndex < moySkladState.nomenclatures.length && isNomenclatureDone(nextIndex)) {
                nextIndex++;
            }
            
            if (nextIndex >= moySkladState.nomenclatures.length) {
                // All done, check from beginning
                nextIndex = moySkladState.nomenclatures.findIndex((_, i) => !isNomenclatureDone(i));
            }
            
            if (nextIndex === -1) {
                // All really done
                renderConveyor();
                return;
            }
            
            selectNomenclature(nextIndex);
        }
        
        function resetMoySkladProgress() {
            moySkladState.currentNomIndex = 0;
            moySkladState.currentCodeIndex = 0;
            moySkladState.copiedCodes.clear();
            moySkladState.totalCopied = 0;
            
            initMoySklad();
            showToast('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω', 'success');
        }
        
        function updateMoySkladStats() {
            const total = moySkladState.nomenclatures.reduce((sum, nom) => sum + nom.codes.length, 0);
            const copied = moySkladState.copiedCodes.size;
            
            document.getElementById('msTotal').textContent = total;
            document.getElementById('msCopied').textContent = copied;
            document.getElementById('msRemaining').textContent = total - copied;
        }
        
        // Handle spacebar for conveyor
        document.addEventListener('keydown', (e) => {
            // Only on MoySklad tab and not in input
            if (document.getElementById('tab-moysklad').classList.contains('active') &&
                e.target.tagName !== 'INPUT' && 
                e.target.tagName !== 'SELECT' &&
                e.code === 'Space') {
                e.preventDefault();
                copyAndNext();
            }
        });
        
        function updateProgress() {
            const panel = document.getElementById('progressPanel');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            if (!state.target || state.target <= 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            const current = getCurrentRecords().length;
            const percent = Math.min(100, Math.round(current / state.target * 100));
            fill.style.width = percent + '%';
            text.textContent = `${current} / ${state.target} (${percent}%)`;
        }
        
        // ============ COLORS ============
        function addColor() {
            const input = document.getElementById('newColorInput');
            const color = input.value.trim();
            if (!color) { showToast('–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç', 'error'); return; }
            if (state.colors.includes(color)) { showToast('–¶–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å', 'warning'); return; }
            state.colors.push(color);
            input.value = '';
            saveState();
            renderAll();
            showToast('–¶–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }
        
        function removeColor(color) {
            if (state.colors.length <= 1) { showToast('–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã 1 —Ü–≤–µ—Ç', 'error'); return; }
            state.colors = state.colors.filter(c => c !== color);
            saveState();
            renderAll();
        }
        
        // ============ BOXES ============
        function showNewBoxModal() {
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">üì¶ –ù–æ–≤–∞—è –∫–æ—Ä–æ–±–∫–∞</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="field">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="newBoxName" placeholder="–ö–æ—Ä–æ–±–∫–∞ 1">
                        </div>
                        <div class="field">
                            <label>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (0 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)</label>
                            <input type="number" id="newBoxCapacity" value="10" min="0">
                        </div>
                        <button class="btn btn-primary" onclick="createBox()" style="margin-top: 12px;">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function createBox() {
            const name = document.getElementById('newBoxName').value.trim() || `–ö–æ—Ä–æ–±–∫–∞ ${state.boxes.length + 1}`;
            const capacity = parseInt(document.getElementById('newBoxCapacity').value) || 0;
            
            state.boxes.push({
                id: 'box_' + Date.now(),
                name,
                capacity
            });
            
            saveState();
            closeModal();
            renderAll();
            showToast('–ö–æ—Ä–æ–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
        }
        
        function editBox(boxId) {
            const box = state.boxes.find(b => b.id === boxId);
            if (!box) return;
            
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ–±–∫—É</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="field">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="editBoxName" value="${escapeHtml(box.name)}">
                        </div>
                        <div class="field">
                            <label>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</label>
                            <input type="number" id="editBoxCapacity" value="${box.capacity}" min="0">
                        </div>
                        <button class="btn btn-primary" onclick="saveBoxEdit('${boxId}')" style="margin-top: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function saveBoxEdit(boxId) {
            const box = state.boxes.find(b => b.id === boxId);
            if (!box) return;
            
            box.name = document.getElementById('editBoxName').value.trim() || box.name;
            box.capacity = parseInt(document.getElementById('editBoxCapacity').value) || 0;
            
            saveState();
            closeModal();
            renderAll();
            showToast('–ö–æ—Ä–æ–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        }
        
        function deleteBox(boxId) {
            // Remove box reference from records
            getCurrentRecords().forEach(r => {
                if (r.boxId === boxId) r.boxId = null;
            });
            
            state.boxes = state.boxes.filter(b => b.id !== boxId);
            saveState();
            renderAll();
            showToast('–ö–æ—Ä–æ–±–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        }
        
        // ============ LABELS & PDF ============
        function printBoxLabel(boxId) {
            const box = state.boxes.find(b => b.id === boxId);
            if (!box) return;
            
            const records = getCurrentRecords().filter(r => r.boxId === boxId);
            
            // Summarize
            const summary = {};
            records.forEach(r => {
                const key = `${r.color} | –†–∞–∑–º–µ—Ä ${r.size}`;
                summary[key] = (summary[key] || 0) + 1;
            });
            
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">üè∑Ô∏è –≠—Ç–∏–∫–µ—Ç–∫–∞ –∫–æ—Ä–æ–±–∫–∏</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="label-preview" id="labelPreview">
                            <h3>üì¶ ${escapeHtml(box.name)}</h3>
                            <div class="label-info"><strong>–ú–æ–¥–µ–ª—å:</strong> Azza Fencing</div>
                            <div class="label-info"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${records.length} —à—Ç.</div>
                            <div class="label-info"><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
                            <div class="label-contents">
                                <strong>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:</strong><br>
                                ${Object.entries(summary).map(([k, v]) => `${k}: ${v} —à—Ç.`).join('<br>')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="printLabel()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                            <button class="btn btn-ghost" onclick="downloadLabelPDF('${boxId}')">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function printLabel() {
            const content = document.getElementById('labelPreview').innerHTML;
            const win = window.open('', '_blank');
            win.document.write(`
                <html><head><title>–≠—Ç–∏–∫–µ—Ç–∫–∞</title>
                <style>
                    body { font-family: Arial; padding: 20px; }
                    h3 { margin: 0 0 10px; }
                    .label-info { margin: 5px 0; font-size: 14px; }
                    .label-contents { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 12px; }
                </style>
                </head><body>${content}</body></html>
            `);
            win.document.close();
            win.print();
        }
        
        function downloadLabelPDF(boxId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Setup font
            const useCyrillic = setupCyrillicFont(doc);
            const t = useCyrillic ? (s) => s : transliterate;
            
            const box = state.boxes.find(b => b.id === boxId);
            const records = getCurrentRecords().filter(r => r.boxId === boxId);
            
            const summary = {};
            records.forEach(r => {
                const key = `${r.color} | ${t('–†–∞–∑–º–µ—Ä')} ${r.size}`;
                summary[key] = (summary[key] || 0) + 1;
            });
            
            doc.setFontSize(20);
            doc.text(`${t('–ö–æ—Ä–æ–±–∫–∞')}: ${t(box.name)}`, 20, 30);
            
            doc.setFontSize(12);
            doc.text(`${t('–ú–æ–¥–µ–ª—å')}: Azza Fencing`, 20, 45);
            doc.text(`${t('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ')}: ${records.length} ${t('—à—Ç')}.`, 20, 55);
            doc.text(`${t('–î–∞—Ç–∞')}: ${new Date().toLocaleDateString('ru-RU')}`, 20, 65);
            
            doc.text(`${t('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ')}:`, 20, 80);
            let y = 90;
            Object.entries(summary).forEach(([k, v]) => {
                doc.text(`- ${t(k)}: ${v} ${t('—à—Ç')}.`, 25, y);
                y += 8;
            });
            
            doc.save(`${t('–≠—Ç–∏–∫–µ—Ç–∫–∞')}_${t(box.name)}.pdf`);
        }
        
        function setupCyrillicFont(doc) {
            if (cyrillicFontLoaded && cyrillicFontData) {
                try {
                    doc.addFileToVFS('Roboto-Regular.ttf', cyrillicFontData);
                    doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
                    doc.setFont('Roboto');
                    return true;
                } catch (e) {
                    console.log('Font setup failed, using transliteration');
                }
            }
            return false;
        }
        
        function printAllLabels() {
            state.boxes.forEach(box => {
                downloadLabelPDF(box.id);
            });
            showToast('–≠—Ç–∏–∫–µ—Ç–∫–∏ —Å–∫–∞—á–∞–Ω—ã', 'success');
        }
        
        // Transliteration for PDF (fallback for Cyrillic)
        function transliterate(text) {
            if (!text) return '';
            const map = {
                '–ê':'A','–ë':'B','–í':'V','–ì':'G','–î':'D','–ï':'E','–Å':'Yo','–ñ':'Zh',
                '–ó':'Z','–ò':'I','–ô':'Y','–ö':'K','–õ':'L','–ú':'M','–ù':'N','–û':'O',
                '–ü':'P','–†':'R','–°':'S','–¢':'T','–£':'U','–§':'F','–•':'Kh','–¶':'Ts',
                '–ß':'Ch','–®':'Sh','–©':'Shch','–™':'','–´':'Y','–¨':'','–≠':'E','–Æ':'Yu','–Ø':'Ya',
                '–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'yo','–∂':'zh',
                '–∑':'z','–∏':'i','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o',
                '–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts',
                '—á':'ch','—à':'sh','—â':'shch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'
            };
            return String(text).split('').map(c => map[c] || c).join('');
        }
        
        function generatePackingListPDF() {
            const records = getCurrentRecords();
            if (records.length === 0) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Setup font
            const useCyrillic = setupCyrillicFont(doc);
            const t = useCyrillic ? (s) => s : transliterate;
            
            // Header
            doc.setFontSize(18);
            doc.text(t('–£–ü–ê–ö–û–í–û–ß–ù–´–ô –õ–ò–°–¢'), 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text(`${t('–î–∞—Ç–∞')}: ${new Date().toLocaleDateString('ru-RU')}`, 20, 35);
            doc.text(`${t('–ú–æ–¥–µ–ª—å')}: Azza Fencing`, 20, 42);
            doc.text(`${t('–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü')}: ${records.length}`, 20, 49);
            doc.text(`${t('–ö–æ—Ä–æ–±–æ–∫')}: ${state.boxes.length}`, 20, 56);
            
            // Summary by color and size
            const summary = {};
            state.colors.forEach(c => { summary[c] = {}; for(let s=36;s<=47;s++) summary[c][s]=0; });
            records.forEach(r => { if(summary[r.color]) summary[r.color][r.size]++; });
            
            // Summary table
            const summaryData = [];
            state.colors.forEach(color => {
                const row = [t(color)];
                let total = 0;
                for(let s=36;s<=47;s++) {
                    row.push(summary[color][s] || '-');
                    total += summary[color][s];
                }
                row.push(total);
                summaryData.push(row);
            });
            
            const headers = [t('–¶–≤–µ—Ç'), ...Array.from({length:12}, (_,i) => String(36+i)), t('–ò—Ç–æ–≥–æ')];
            
            doc.autoTable({
                startY: 65,
                head: [headers],
                body: summaryData,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2, font: useCyrillic ? 'Roboto' : 'helvetica' },
                headStyles: { fillColor: [0, 150, 200] }
            });
            
            // Boxes detail
            let y = doc.lastAutoTable.finalY + 15;
            
            if (state.boxes.length > 0) {
                doc.setFontSize(14);
                doc.text(t('–°–û–î–ï–†–ñ–ò–ú–û–ï –ö–û–†–û–ë–û–ö'), 20, y);
                y += 10;
                
                state.boxes.forEach(box => {
                    const boxRecords = records.filter(r => r.boxId === box.id);
                    if (boxRecords.length === 0) return;
                    
                    const boxSummary = {};
                    boxRecords.forEach(r => {
                        const key = `${t(r.color)} ${r.size}`;
                        boxSummary[key] = (boxSummary[key] || 0) + 1;
                    });
                    
                    const boxData = Object.entries(boxSummary).map(([k, v]) => [k, v]);
                    
                    doc.setFontSize(11);
                    doc.text(`${t(box.name)} (${boxRecords.length} ${t('—à—Ç')}.)`, 20, y);
                    y += 5;
                    
                    doc.autoTable({
                        startY: y,
                        head: [[t('–¢–æ–≤–∞—Ä'), t('–ö–æ–ª-–≤–æ')]],
                        body: boxData,
                        theme: 'striped',
                        styles: { fontSize: 9, font: useCyrillic ? 'Roboto' : 'helvetica' },
                        margin: { left: 25 }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                });
            }
            
            // Full list on new page
            doc.addPage();
            doc.setFontSize(14);
            if (useCyrillic) doc.setFont('Roboto');
            doc.text(t('–ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í'), 20, 20);
            
            const fullData = records.map((r, i) => {
                const box = state.boxes.find(b => b.id === r.boxId);
                return [i+1, t(r.color), r.size, box ? t(box.name) : '-', r.gtin];
            });
            
            doc.autoTable({
                startY: 30,
                head: [['‚Ññ', t('–¶–≤–µ—Ç'), t('–†–∞–∑–º–µ—Ä'), t('–ö–æ—Ä–æ–±–∫–∞'), 'GTIN']],
                body: fullData,
                theme: 'grid',
                styles: { fontSize: 8, font: useCyrillic ? 'Roboto' : 'helvetica' },
                headStyles: { fillColor: [0, 150, 200] }
            });
            
            const sessionName = state.sessions[state.currentSession]?.name || 'export';
            doc.save(`${t('–£–ø–∞–∫–æ–≤–æ—á–Ω—ã–π_–ª–∏—Å—Ç')}_${t(sessionName)}_${new Date().toISOString().slice(0,10)}.pdf`);
            
            showToast('PDF —Å–æ–∑–¥–∞–Ω', 'success');
        }
        
        // ============ STREAM MODE ============
        function toggleStreamMode() {
            const color = document.getElementById('colorSelect').value;
            const size = document.getElementById('sizeSelect').value;
            const box = document.getElementById('boxSelect').value;
            
            if (!state.streamMode.active) {
                if (!color || !size) {
                    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞', 'error');
                    return;
                }
                
                state.streamMode = { active: true, color, size, box };
                document.getElementById('streamModePanel').style.display = 'block';
                document.getElementById('streamModeBtn').classList.add('stream-mode-active');
                document.getElementById('streamColor').textContent = color;
                document.getElementById('streamSize').textContent = size;
                document.getElementById('streamBox').textContent = box ? state.boxes.find(b => b.id === box)?.name : '–Ω–µ—Ç';
                
                // Disable selects
                document.getElementById('colorSelect').disabled = true;
                document.getElementById('sizeSelect').disabled = true;
                document.getElementById('boxSelect').disabled = true;
                
                speak('–ü–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω');
                showToast('üî• –ü–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω', 'warning');
            } else {
                state.streamMode = { active: false, color: null, size: null, box: null };
                document.getElementById('streamModePanel').style.display = 'none';
                document.getElementById('streamModeBtn').classList.remove('stream-mode-active');
                
                document.getElementById('colorSelect').disabled = false;
                document.getElementById('sizeSelect').disabled = false;
                document.getElementById('boxSelect').disabled = false;
                
                speak('–ü–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω');
                showToast('–ü–æ—Ç–æ–∫–æ–≤—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            }
            
            
        }
        
        // ============ SCANNER INPUT BUFFER ============
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤–≤–æ–¥–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–∞
        let scanBuffer = '';
        let scanTimeout = null;
        const SCAN_TIMEOUT_MS = 50;
        
        document.addEventListener('keypress', (e) => {
            const tag = e.target.tagName;
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º textarea –∏ input
            if (tag === 'TEXTAREA' || tag === 'INPUT' || tag === 'SELECT') return;
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            
            // –°–æ–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã
            if (e.key.length === 1) {
                scanBuffer += e.key;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–∏—Å–ø–ª–µ–µ
                const display = document.getElementById('scanDisplay');
                if (display) {
                    display.textContent = scanBuffer.substring(0, 50) + (scanBuffer.length > 50 ? '...' : '');
                    display.style.borderColor = 'var(--accent)';
                    display.style.color = '#ffd700';
                }
                
                if (scanTimeout) clearTimeout(scanTimeout);
                scanTimeout = setTimeout(processScanBuffer, SCAN_TIMEOUT_MS);
            }
        });
        
        // Enter –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && scanBuffer.length > 20) {
                e.preventDefault();
                if (scanTimeout) clearTimeout(scanTimeout);
                processScanBuffer();
            }
        });
        
        function processScanBuffer() {
            const code = scanBuffer.trim();
            scanBuffer = '';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∏—Å–ø–ª–µ–π
            const display = document.getElementById('scanDisplay');
            if (display) {
                display.textContent = '‚è≥ –ù–∞–≤–µ–¥–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä...';
                display.style.borderColor = 'var(--border)';
                display.style.color = 'var(--accent)';
            }
            
            if (code.length < 30) return;
            
            console.log('SCAN:', code.substring(0, 40) + '...');
            processScan(code);
        }
        
        // ============ SCANNING ============
        let pendingScan = null; // Store pending scan while waiting for user input
        
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text && text.length > 20) {
                    processScan(text);
                } else {
                    showToast('–ë—É—Ñ–µ—Ä –ø—É—Å—Ç –∏–ª–∏ –∫–æ–¥ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'warning');
                }
            } catch (err) {
                showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞', 'error');
            }
        }
        
        // Ctrl+V –≥–ª–æ–±–∞–ª—å–Ω–æ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'v') {
                const tag = e.target.tagName;
                if (tag !== 'INPUT' && tag !== 'TEXTAREA') {
                    e.preventDefault();
                    pasteFromClipboard();
                }
            }
        });
        
        function processScan(rawCode) {
            const code = rawCode.trim();
            
            if (!code) return;
            
            const parsed = parseMarkingCode(code);
            
            if (!parsed) {
                console.log('Parse failed for code length:', code.length, 'start:', code.substring(0, 30));
                showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞', 'error');
                playSound('error');
                speak('–û—à–∏–±–∫–∞');
                return;
            }
            
            // Check duplicates using shortCode (normalized)
            if (getCurrentRecords().some(r => r.shortCode === parsed.shortCode)) {
                showToast('‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç!', 'warning');
                playSound('error');
                speak('–î—É–±–ª–∏–∫–∞—Ç');
                return;
            }
            
            let color, size, boxId;
            
            // Check if in stream mode
            if (state.streamMode.active) {
                color = state.streamMode.color;
                size = state.streamMode.size;
                boxId = state.streamMode.box;
            } 
            // Check auto mode - look up GTIN in catalog
            else if (state.autoMode && state.gtinCatalog[parsed.gtin]) {
                const catalogEntry = state.gtinCatalog[parsed.gtin];
                color = catalogEntry.color;
                size = catalogEntry.size;
                boxId = document.getElementById('boxSelect').value || null;
                
                // Increment scan count
                catalogEntry.scanCount = (catalogEntry.scanCount || 0) + 1;
            }
            // Auto mode but GTIN not in catalog - ask user
            else if (state.autoMode && !state.gtinCatalog[parsed.gtin]) {
                pendingScan = { code, parsed, boxId: document.getElementById('boxSelect').value || null };
                showNewGtinModal(parsed.gtin);
                return;
            }
            // Manual mode
            else {
                color = document.getElementById('colorSelect').value;
                size = document.getElementById('sizeSelect').value;
                boxId = document.getElementById('boxSelect').value || null;
                
                if (!color) {
                    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç', 'error');
                    playSound('error');
                    return;
                }
                
                if (!size) {
                    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä', 'error');
                    playSound('error');
                    return;
                }
            }
            
            // Check box capacity
            if (boxId) {
                const box = state.boxes.find(b => b.id === boxId);
                if (box && box.capacity > 0) {
                    const count = getCurrentRecords().filter(r => r.boxId === boxId).length;
                    if (count >= box.capacity) {
                        showToast('–ö–æ—Ä–æ–±–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!', 'error');
                        playSound('error');
                        speak('–ö–æ—Ä–æ–±–∫–∞ –ø–æ–ª–Ω–∞—è');
                        return;
                    }
                }
            }
            
            // Add record
            addRecord(color, size, boxId, parsed, code);
        }
        
        function addRecord(color, size, boxId, parsed, code) {
            // Check reconciliation
            const recCheck = checkReconciliation(color, size);
            
            getCurrentRecords().push({
                color,
                size,
                boxId,
                gtin: parsed.gtin,
                shortCode: parsed.shortCode,
                fullCode: code,
                status: 'unknown',
                mode: state.workMode,
                timestamp: new Date().toISOString()
            });
            
            saveState();
            renderAll();
            
            // Update reconciliation if active
            if (reconciliation.active) {
                updateReconciliationUI();
            }
            
            const sizeWord = getSizeWord(size);
            const actionText = getModeActionText();
            
            // Handle reconciliation warnings
            if (recCheck.status === 'not_in_list') {
                playSound('error');
                speak(`–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ—Ç –≤ –Ω–∞–∫–ª–∞–¥–Ω–æ–π!`);
                showToast(recCheck.message, 'warning');
            } else if (recCheck.status === 'extra') {
                playSound('error');
                speak(`–í–Ω–∏–º–∞–Ω–∏–µ! –õ–∏—à–Ω–∏–π —Ç–æ–≤–∞—Ä!`);
                showToast(recCheck.message, 'warning');
            } else {
                playSound('success');
                speak(`${color}, ${sizeWord}, ${actionText}`);
                showToast(`‚úì ${workModeConfig[state.workMode].name}: –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');
            }
        }
        
        function showNewGtinModal(gtin) {
            const html = `
                <div class="modal-overlay">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">üÜï –ù–æ–≤—ã–π GTIN</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                            –≠—Ç–æ—Ç GTIN –µ—â—ë –Ω–µ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ. –£–∫–∞–∂–∏—Ç–µ —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–æ–º–Ω–∏—Ç.
                        </p>
                        <div style="background: var(--bg-panel); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-family: monospace; font-size: 13px;">
                            GTIN: <strong style="color: #ffd700;">${gtin}</strong>
                        </div>
                        <div class="grid-2" style="gap: 12px;">
                            <div class="field">
                                <label>–¶–≤–µ—Ç *</label>
                                <select id="newGtinColor">
                                    ${state.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="field">
                                <label>–†–∞–∑–º–µ—Ä *</label>
                                <select id="newGtinSize">
                                    ${Array.from({length: 12}, (_, i) => 36 + i).map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="confirmNewGtin('${gtin}')" style="flex: 1;">
                                ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å
                            </button>
                            <button class="btn btn-ghost" onclick="cancelNewGtin()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
            
            // Focus on color select
            setTimeout(() => document.getElementById('newGtinColor').focus(), 100);
        }
        
        function confirmNewGtin(gtin) {
            const color = document.getElementById('newGtinColor').value;
            const size = document.getElementById('newGtinSize').value;
            
            if (!color || !size) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä', 'error');
                return;
            }
            
            // Add to catalog
            state.gtinCatalog[gtin] = {
                color,
                size,
                model: 'Azza Fencing',
                addedAt: new Date().toISOString(),
                scanCount: 1
            };
            
            // Process the pending scan
            if (pendingScan) {
                addRecord(color, size, pendingScan.boxId, pendingScan.parsed, pendingScan.code);
                pendingScan = null;
            }
            
            closeModal();
            saveState();
            renderCatalog();
            
            showToast(`GTIN –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥: ${color}, ${size}`, 'success');
            
        }
        
        function cancelNewGtin() {
            pendingScan = null;
            closeModal();
            
            showToast('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'warning');
        }
        
        function getSizeWord(size) {
            const words = {
                '36': '—Ç—Ä–∏–¥—Ü–∞—Ç—å —à–µ—Å—Ç—å',
                '37': '—Ç—Ä–∏–¥—Ü–∞—Ç—å —Å–µ–º—å',
                '38': '—Ç—Ä–∏–¥—Ü–∞—Ç—å –≤–æ—Å–µ–º—å',
                '39': '—Ç—Ä–∏–¥—Ü–∞—Ç—å –¥–µ–≤—è—Ç—å',
                '40': '—Å–æ—Ä–æ–∫',
                '41': '—Å–æ—Ä–æ–∫ –æ–¥–∏–Ω',
                '42': '—Å–æ—Ä–æ–∫ –¥–≤–∞',
                '43': '—Å–æ—Ä–æ–∫ —Ç—Ä–∏',
                '44': '—Å–æ—Ä–æ–∫ —á–µ—Ç—ã—Ä–µ',
                '45': '—Å–æ—Ä–æ–∫ –ø—è—Ç—å',
                '46': '—Å–æ—Ä–æ–∫ —à–µ—Å—Ç—å',
                '47': '—Å–æ—Ä–æ–∫ —Å–µ–º—å'
            };
            return words[size] || size;
        }
        
        function parseMarkingCode(code) {
            // Structure: 01 + GTIN(14) + 21 + Serial(6-13) + GS + 91 + Key(4) + GS + 92 + Crypto(88)
            // GS = ASCII 29 (Group Separator) - –Ω–µ–≤–∏–¥–∏–º—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            // –ü—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ GS –º–æ–∂–µ—Ç –∏—Å—á–µ–∑–Ω—É—Ç—å, —Ç–æ–≥–¥–∞ –∏—â–µ–º –ø–æ "91"
            
            const GS = String.fromCharCode(29); // Group Separator
            
            // Keep GS for parsing, remove other control chars
            let cleanCode = code.replace(/[\x00-\x1C\x1E-\x1F\x7F]/g, '').trim();
            
            // Find 01 (GTIN application identifier)
            const idx01 = cleanCode.indexOf('01');
            if (idx01 === -1) return null;
            
            // GTIN is 14 digits after "01"
            const gtinStart = idx01 + 2;
            const gtinCandidate = cleanCode.substring(gtinStart, gtinStart + 14);
            if (!/^\d{14}$/.test(gtinCandidate)) return null;
            const gtin = gtinCandidate;
            
            // Find 21 (Serial number application identifier) after GTIN
            const afterGtin = gtinStart + 14;
            if (cleanCode.substring(afterGtin, afterGtin + 2) !== '21') return null;
            
            // Serial number starts after "21"
            const serialStart = afterGtin + 2;
            let serial;
            
            // Try to find end of serial: GS, then "91", or take 13 chars
            const gsPos = cleanCode.indexOf(GS, serialStart);
            const idx91 = cleanCode.indexOf('91', serialStart);
            
            if (gsPos !== -1 && gsPos < serialStart + 20) {
                // GS separator found
                serial = cleanCode.substring(serialStart, gsPos);
            } else if (idx91 !== -1 && idx91 >= serialStart + 6 && idx91 <= serialStart + 13) {
                // "91" found at reasonable position (serial is 6-13 chars)
                serial = cleanCode.substring(serialStart, idx91);
            } else {
                // Fallback: take 13 chars
                serial = cleanCode.substring(serialStart, serialStart + 13);
            }
            
            if (serial.length < 6 || serial.length > 13) return null;
            
            // ShortCode = 01 + GTIN + 21 + Serial
            const shortCode = '01' + gtin + '21' + serial;
            
            return { gtin, shortCode };
        }
        
        // ============ SELECTION & BATCH DELETE ============
        function toggleRecordSelection(index) {
            if (selectedRecords.has(index)) {
                selectedRecords.delete(index);
            } else {
                selectedRecords.add(index);
            }
            renderTable();
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const records = getCurrentRecords();
            
            if (selectAll) {
                records.forEach((_, i) => selectedRecords.add(i));
            } else {
                selectedRecords.clear();
            }
            
            renderTable();
        }
        
        function updateSelectedCount() {
            const count = selectedRecords.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('deleteSelectedBtn').disabled = count === 0;
        }
        
        function deleteSelected() {
            if (selectedRecords.size === 0) return;
            
            const records = getCurrentRecords();
            const indices = Array.from(selectedRecords).sort((a, b) => b - a);
            
            indices.forEach(i => {
                const deleted = records.splice(i, 1)[0];
                if (deleted) state.deletedRecords.unshift(deleted);
            });
            
            if (state.deletedRecords.length > 100) {
                state.deletedRecords = state.deletedRecords.slice(0, 100);
            }
            
            selectedRecords.clear();
            saveState();
            renderAll();
            showToast(`–£–¥–∞–ª–µ–Ω–æ ${indices.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
        }
        
        // ============ API STATUS CHECK ============
        function saveApiToken() {
            state.apiToken = document.getElementById('apiTokenInput').value.trim();
            saveState();
            updateApiStatus();
        }
        
        function updateApiStatus() {
            const el = document.getElementById('apiStatus');
            const dot = el.querySelector('.api-dot');
            const text = el.querySelector('span:last-child');
            
            if (state.apiToken) {
                dot.className = 'api-dot connected';
                text.textContent = 'API: –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            } else {
                dot.className = 'api-dot';
                text.textContent = 'API: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            }
        }
        
        async function testApiConnection() {
            if (!state.apiToken) {
                showToast('–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω', 'error');
                return;
            }
            
            showToast('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'warning');
            
            // Simulated API check (real API would require CORS proxy)
            setTimeout(() => {
                showToast('API –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)', 'success');
            }, 1000);
        }
        
        async function checkSelectedStatus() {
            if (selectedRecords.size === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error');
                return;
            }
            
            if (!state.apiToken) {
                showToast('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API —Ç–æ–∫–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                return;
            }
            
            const records = getCurrentRecords();
            
            selectedRecords.forEach(i => {
                if (records[i]) records[i].status = 'checking';
            });
            renderTable();
            
            // Simulate API response (real implementation would call actual API)
            setTimeout(() => {
                selectedRecords.forEach(i => {
                    if (records[i]) {
                        // Random status for demo
                        records[i].status = Math.random() > 0.2 ? 'valid' : 'invalid';
                    }
                });
                saveState();
                renderTable();
                showToast('–°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            }, 2000);
        }
        
        // ============ VOICE ============
        function speak(text) {
            if (!state.voiceEnabled || !('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = state.voiceRate;
            utterance.lang = 'ru-RU';
            
            const voices = speechSynthesis.getVoices();
            if (state.selectedVoice !== null && voices[state.selectedVoice]) {
                utterance.voice = voices[state.selectedVoice];
            }
            
            speechSynthesis.speak(utterance);
        }
        
        function toggleVoice() {
            state.voiceEnabled = !state.voiceEnabled;
            document.getElementById('voiceBtn').style.opacity = state.voiceEnabled ? 1 : 0.5;
            saveState();
            showToast(state.voiceEnabled ? '–ì–æ–ª–æ—Å –≤–∫–ª—é—á—ë–Ω' : '–ì–æ–ª–æ—Å –≤—ã–∫–ª—é—á–µ–Ω', 'success');
        }
        
        function saveVoiceSettings() {
            state.selectedVoice = parseInt(document.getElementById('voiceSelect').value);
            saveState();
        }
        
        function updateVoiceRate() {
            state.voiceRate = parseFloat(document.getElementById('voiceRate').value);
            document.getElementById('voiceRateValue').textContent = state.voiceRate.toFixed(1);
            saveState();
        }
        
        function testVoice() {
            speak('–ß—ë—Ä–Ω—ã–π, —Å–æ—Ä–æ–∫ –¥–≤–∞, –ø—Ä–∏–Ω—è—Ç–æ');
        }
        
        // ============ OTHER FUNCTIONS ============
        function deleteRecord(index) {
            const records = getCurrentRecords();
            const deleted = records.splice(index, 1)[0];
            if (deleted) state.deletedRecords.unshift(deleted);
            if (state.deletedRecords.length > 100) state.deletedRecords.pop();
            selectedRecords.delete(index);
            saveState();
            renderAll();
        }
        
        function restoreRecord(index) {
            const record = state.deletedRecords.splice(index, 1)[0];
            if (record) getCurrentRecords().push(record);
            saveState();
            renderAll();
        }
        
        function clearDeleted() {
            state.deletedRecords = [];
            saveState();
            renderDeletedList();
        }
        
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            renderTable();
        }
        
        function filterTable() { renderTable(); }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterColor').value = '';
            document.getElementById('filterSize').value = '';
            document.getElementById('filterBox').value = '';
            renderTable();
        }
        
        function updateTarget() {
            state.target = parseInt(document.getElementById('targetInput').value) || 0;
            saveState();
            updateProgress();
        }
        
        // Sessions
        function showNewSessionModal() {
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">–ù–æ–≤–∞—è –ø–∞—Ä—Ç–∏—è</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="field">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="newSessionName" placeholder="–ü–∞—Ä—Ç–∏—è 2">
                        </div>
                        <button class="btn btn-primary" onclick="createSession()" style="margin-top:12px;">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
        }
        
        function createSession() {
            const name = document.getElementById('newSessionName').value.trim() || `–ü–∞—Ä—Ç–∏—è ${Object.keys(state.sessions).length + 1}`;
            const key = 'session_' + Date.now();
            state.sessions[key] = { name, records: [] };
            state.currentSession = key;
            state.boxes = [];
            saveState();
            closeModal();
            renderAll();
        }
        
        function switchSession() {
            state.currentSession = document.getElementById('sessionSelect').value;
            selectedRecords.clear();
            saveState();
            renderAll();
        }
        
        // Export
        function exportXLSX() {
            const records = getCurrentRecords();
            if (!records.length) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error'); return; }
            
            const data = [
                ['‚Ññ', '–ú–æ–¥–µ–ª—å', '–¶–≤–µ—Ç', '–†–∞–∑–º–µ—Ä', '–ö–æ—Ä–æ–±–∫–∞', 'GTIN', '–û–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫–æ–¥', '–ü–æ–ª–Ω—ã–π –∫–æ–¥'],
                ...records.map((r, i) => {
                    const box = state.boxes.find(b => b.id === r.boxId);
                    return [i+1, 'Azza Fencing', r.color, r.size, box?.name || '', r.gtin, r.shortCode, r.fullCode];
                })
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞');
            ws['!cols'] = [{wch:5},{wch:15},{wch:12},{wch:8},{wch:15},{wch:16},{wch:35},{wch:80}];
            
            const name = state.sessions[state.currentSession]?.name || 'export';
            XLSX.writeFile(wb, `Azza_Fencing_${name}_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }
        
        function exportCSV() {
            const records = getCurrentRecords();
            if (!records.length) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error'); return; }
            
            const BOM = '\uFEFF';
            const headers = ['‚Ññ','–ú–æ–¥–µ–ª—å','–¶–≤–µ—Ç','–†–∞–∑–º–µ—Ä','–ö–æ—Ä–æ–±–∫–∞','GTIN','–û–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫–æ–¥','–ü–æ–ª–Ω—ã–π –∫–æ–¥'];
            const rows = records.map((r,i) => {
                const box = state.boxes.find(b => b.id === r.boxId);
                return [i+1,'Azza Fencing',r.color,r.size,box?.name||'',r.gtin,r.shortCode,r.fullCode];
            });
            
            const csv = BOM + [headers.join(';'), ...rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(';'))].join('\r\n');
            
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Azza_Fencing_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            if (file.name.match(/\.xlsx?$/i)) {
                reader.onload = e => {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    processImport(data);
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = e => {
                    const rows = e.target.result.split(/\r?\n/).map(r => r.split(/[;,]/).map(c => c.replace(/^"|"$/g,'').trim()));
                    processImport(rows);
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }
        
        function processImport(data) {
            let imported = 0;
            data.slice(1).forEach(row => {
                if (row.length >= 8 && row[5]) {
                    const fullCode = String(row[7]).trim();
                    if (fullCode && !getCurrentRecords().some(r => r.fullCode === fullCode)) {
                        getCurrentRecords().push({
                            color: row[2], size: row[3], boxId: null,
                            gtin: row[5], shortCode: row[6], fullCode, status: 'unknown'
                        });
                        imported++;
                    }
                }
            });
            saveState();
            renderAll();
            showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported}`, 'success');
        }
        
        // Camera
        function showCameraModal() {
            const html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <span class="modal-title">üì∑ –ö–∞–º–µ—Ä–∞</span>
                            <button class="modal-close" onclick="closeCameraModal()">&times;</button>
                        </div>
                        <div id="camera-preview" style="width:100%;border-radius:12px;overflow:hidden;"></div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = html;
            
            html5QrCode = new Html5Qrcode("camera-preview");
            html5QrCode.start(
                {facingMode:"environment"},
                {fps:10, qrbox:{width:250,height:250}},
                text => processScan(text),
                () => {}
            ).catch(() => showToast('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã', 'error'));
        }
        
        function closeCameraModal() {
            if (html5QrCode) { html5QrCode.stop().catch(()=>{}); html5QrCode = null; }
            closeModal();
        }
        
        // UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Initialize MoySklad when switching to that tab
            if (tabId === 'moysklad') {
                initMoySklad();
            }
            
            // Update reconciliation when switching to that tab
            if (tabId === 'reconciliation' && reconciliation.active) {
                updateReconciliationUI();
            }
        }
        
        function toggleTheme() {
            const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', theme);
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            document.getElementById('soundBtn').textContent = state.soundEnabled ? 'üîä' : 'üîá';
            saveState();
        }
        
        function playSound(type) {
            if (!state.soundEnabled) return;
            const audio = document.getElementById(type + 'Sound');
            if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
        }
        
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modalContainer').innerHTML = '';
        }
        
        function showToast(message, type = 'success') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
